<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikimedia Impact Analyzer</title>
    <style>
        /* Global improvements */
        html {
            scroll-behavior: smooth;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border: #dee2e6;
            --accent: #0d6efd;
            --accent-hover: #0b5ed7;
            --success: #198754;
            --success-bg: #d1e7dd;
            --warning: #ffc107;
            --warning-bg: #fff3cd;
            --danger: #dc3545;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #171717;
            --bg-secondary: #1f1f1f;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border: #444;
            --accent: #60a5fa;
            --accent-hover: #3b82f6;
            --success: #34d399;
            --success-bg: #14532d;
            --warning: #fbbf24;
            --warning-bg: #4d3d00;
            --danger: #f87171;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
            min-height: 100vh;
            font-feature-settings: "liga" 1, "calt" 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
        }

        .icon-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .form-section {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        input[type="radio"]+.duration-label {
            transition: all 0.2s ease;
        }

        input[type="radio"]:focus-visible+.duration-label,
        input[type="checkbox"]:focus-visible+span {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .duration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .duration-option {
            position: relative;
        }

        .duration-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .duration-label {
            display: block;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .duration-option input[type="radio"]:checked+.duration-label {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .duration-label:hover {
            border-color: var(--accent);
        }

        .duration-main {
            font-weight: 600;
            display: block;
        }

        .duration-sub {
            font-size: 12px;
            opacity: 0.8;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-warning {
            background: var(--warning-bg);
            color: var(--text-primary);
            border: 1px solid var(--warning);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            padding: 16px;
            color: var(--text-secondary);
        }

        .error {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: 8px;
            color: var(--danger);
            margin-bottom: 20px;
            display: none;
        }

        .progress-container {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            box-shadow: var(--card-shadow);
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            margin-top: 8px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            justify-content: space-between;
        }

        .card-header:hover {
            opacity: 0.8;
        }

        .card-header>div:last-child {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .card-header .icon-btn {
            padding: 6px 10px;
            font-size: 13px;
            margin: 0;
        }

        .card-header .icon-btn:hover {
            background: var(--accent);
            color: white;
        }

        .collapse-icon {
            transition: transform 0.3s;
            font-size: 14px;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .card-content {
            max-height: none;
            overflow: visible;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            opacity: 1;
        }

        .card-content.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .summary {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .summary-item {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: var(--bg-tertiary);
        }

        th .sort-icon::after {
            content: '‚ñº';
            margin-left: 4px;
            font-size: 12px;
            opacity: 0.3;
        }

        th.sort-asc .sort-icon::after {
            content: '‚ñ≤';
            opacity: 1;
        }

        th.sort-desc .sort-icon::after {
            content: '‚ñº';
            opacity: 1;
        }

        tr:hover {
            background-color: color-mix(in srgb, var(--bg-secondary) 80%, transparent);
            transition: background-color 0.15s ease;
        }

        td a {
            color: var(--accent);
            text-decoration: none;
            position: relative;
            z-index: 1;
            display: inline-block;
            padding: 4px 0;
            cursor: pointer;
        }

        td a:hover {
            text-decoration: underline;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success-bg);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-bg);
            color: var(--warning);
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .title {
                font-size: 20px;
            }

            .duration-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            table {
                font-size: 12px;
            }

            th,
            td {
                padding: 8px;
            }

            .summary {
                gap: 8px;
            }

            .summary-item {
                min-width: 100px;
            }

            .summary-value {
                font-size: 20px;
            }
        }

        /* User Info Styles */
        .user-info-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            display: none;
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .user-info-item {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .user-info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .user-info-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .wiki-chip-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .wiki-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            text-decoration: none;
            border: 1px solid transparent;
            transition: all .15s ease;
            white-space: nowrap;
        }

        .wiki-chip:hover {
            transform: translateY(-1px);
            filter: brightness(.95);
        }

        .wiki-chip.home {
            box-shadow: 0 0 0 2px #ff9800;
            font-weight: 600;
        }

        .wiki-chip img {
            width: 14px;
            height: 14px;
        }

        .wiki-wikipedia {
            background: #e3f2fd;
            color: #0d47a1;
            border-color: #bbdefb;
        }

        .wiki-commons {
            background: #e8f5e9;
            color: #1b5e20;
            border-color: #c8e6c9;
        }

        .wiki-wikidata {
            background: #ede7f6;
            color: #4527a0;
            border-color: #d1c4e9;
        }

        .wiki-wikisource {
            background: #fff8e1;
            color: #e65100;
            border-color: #ffecb3;
        }

        .wiki-other {
            background: #eceff1;
            color: #37474f;
            border-color: #cfd8dc;
        }

        .badge-mini {
            background: rgba(0, 0, 0, .15);
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
    </style>
    <!-- Tambahkan di akhir <head> atau sebelum </body> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="title">
                    <span>üìä</span>
                    <span data-i18n="title">Wikimedia Impact Analyzer</span>
                </div>
                <div class="controls">
                    <a href="/" class="icon-btn" style="text-decoration: none;">
                        <span>‚Üê</span>
                        <span data-i18n="backHome">Kembali ke Affandy Murad</span>
                    </a>
                    <button class="icon-btn" id="langBtn">
                        <span>üåê</span>
                        <span id="langText">EN</span>
                    </button>
                    <button class="icon-btn" id="lightThemeBtn">
                        <span>‚òÄÔ∏è</span>
                    </button>
                    <button class="icon-btn" id="darkThemeBtn">
                        <span>üåô</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="username" data-i18n="username">Username Wikimedia</label>
                <input type="text" id="username" required autocomplete="username"
                    data-i18n-placeholder="examplePlaceholder" placeholder="Contoh: Example">
            </div>

            <div class="form-group">
                <label for="project" data-i18n="project">Wikimedia Project URL</label>
                <input type="text" id="project" placeholder="id.wikipedia.org">
            </div>

            <div class="form-group">
                <label data-i18n="duration">Analysis Duration</label>
                <div class="duration-grid">
                    <div class="duration-option">
                        <input type="radio" name="duration" value="1" id="d1" checked>
                        <label for="d1" class="duration-label">
                            <span class="duration-main" data-i18n="day1">1 Day</span>
                            <span class="duration-sub">‚â§ 300</span>
                        </label>
                    </div>
                    <div class="duration-option">
                        <input type="radio" name="duration" value="7" id="d7">
                        <label for="d7" class="duration-label">
                            <span class="duration-main" data-i18n="day7">7 Days</span>
                            <span class="duration-sub">‚â§ 1,000</span>
                        </label>
                    </div>
                    <div class="duration-option">
                        <input type="radio" name="duration" value="30" id="d30">
                        <label for="d30" class="duration-label">
                            <span class="duration-main" data-i18n="day30">30 Days</span>
                            <span class="duration-sub">‚â§ 3,000</span>
                        </label>
                    </div>
                    <div class="duration-option">
                        <input type="radio" name="duration" value="90" id="d90">
                        <label for="d90" class="duration-label">
                            <span class="duration-main" data-i18n="day90">3 Months</span>
                            <span class="duration-sub">‚â§ 10,000</span>
                        </label>
                    </div>
                    <div class="duration-option">
                        <input type="radio" name="duration" value="180" id="d180">
                        <label for="d180" class="duration-label">
                            <span class="duration-main" data-i18n="day180">6 Months</span>
                            <span class="duration-sub">‚â§ 20,000</span>
                        </label>
                    </div>
                    <div class="duration-option">
                        <input type="radio" name="duration" value="365" id="d365">
                        <label for="d365" class="duration-label">
                            <span class="duration-main" data-i18n="day365">1 Year</span>
                            <span class="duration-sub">‚â§ 50,000</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label data-i18n="filterOptions">Filter Options</label>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                        <input type="checkbox" id="includeMinor" checked>
                        <span data-i18n="includeMinorEdits">Include minor edits (< 100 bytes)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                        <input type="checkbox" id="mainNamespaceOnly">
                        <span data-i18n="mainNamespaceOnly">Main namespace only (exclude talk, user pages, etc.)</span>
                    </label>
                </div>
            </div>

            <div class="alert alert-warning">
                <span>‚ö†Ô∏è</span>
                <span data-i18n="warning">Longer durations will take more time and API requests</span>
            </div>

            <button class="btn-primary" id="analyzeBtn">
                <span data-i18n="analyze">Analyze Impact</span>
            </button>
        </div>

        <div class="status" id="status"></div>
        <div class="error" id="error"></div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
        </div>

        <div class="user-info-card" id="userInfoCard">
            <div class="card-header" role="button" tabindex="0" onclick="toggleCollapse('userInfo')"
                aria-expanded="true" aria-controls="userInfoContent">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>üë§</span>
                    <span data-i18n="userInfo">User Information</span>
                </div>
                <span class="collapse-icon" id="userInfoCollapseIcon" aria-hidden="true">‚ñº</span>
            </div>

            <div class="card-content" id="userInfoContent">
                <h4 style="margin-bottom: 12px; font-size: 16px;">üìç <span data-i18n="localInfo">Local
                        Information</span></h4>
                <div class="user-info-grid" id="localInfo"></div>

                <h4 style="margin: 20px 0 12px; font-size: 16px;">üåê <span data-i18n="globalInfo">Global Account
                        Status</span></h4>
                <div class="user-info-grid" id="globalInfo"></div>

                <div id="mergedWikis" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div class="card" id="resultCard" style="display:none">
            <div class="card-header" role="button" tabindex="0" onclick="toggleCollapse('result')" aria-expanded="true"
                aria-controls="resultContent">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>‚úèÔ∏è</span>
                    <span data-i18n="contributions">Your Contributions</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="icon-btn" onclick="event.stopPropagation(); exportPDF()">
                        <span>üìÑ</span>
                        <span data-i18n="exportPDF">Ekspor PDF</span>
                    </button>
                    <button class="icon-btn" onclick="event.stopPropagation(); exportJSON()">
                        <span>üìÑ</span>
                        <span data-i18n="exportJSON">Export JSON</span>
                    </button>
                    <span class="collapse-icon" id="resultCollapseIcon" aria-hidden="true">‚ñº</span>
                </div>
            </div>

            <div class="card-content" id="resultContent">
                <div class="summary" id="summary"></div>

                <div class="table-container">
                    <table id="resultTable">
                        <thead id="resultTableHead">
                            <!-- Header akan diupdate via JS -->
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" id="trendingCard" style="display:none">
            <div class="card-header" role="button" tabindex="0" onclick="toggleCollapse('trending')"
                aria-expanded="true" aria-controls="trendingContent">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>üî•</span>
                    <span data-i18n="trending">Top 30 Trending Articles</span>
                </div>
                <span class="collapse-icon" id="trendingCollapseIcon" aria-hidden="true">‚ñº</span>
            </div>
            <div class="card-content" id="trendingContent">
                <div class="table-container">
                    <table id="trendingTable">
                        <thead>
                            <tr>
                                <th data-i18n="article">Article</th>
                                <th data-i18n="pageviews">Pageviews</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const THRESHOLDS = { 1: 300, 7: 1000, 30: 3000, 90: 10000, 180: 20000, 365: 50000 };

        let currentSortColumn = -1;
        let currentSortDirection = 'asc';
        let currentLang = localStorage.getItem('language');

        // Defensive language selection
        if (!['id', 'en'].includes(currentLang)) {
            currentLang = 'id';
            localStorage.setItem('language', currentLang);
        }

        const translations = {
            id: {
                title: 'Analisis Dampak Wikimedia',
                backHome: 'Kembali ke Affandy Murad',
                username: 'Username Wikimedia',
                examplePlaceholder: 'Contoh: Example',
                project: 'URL Proyek Wikimedia',
                duration: 'Durasi Analisis',
                day1: '1 Hari',
                day7: '7 Hari',
                day30: '30 Hari',
                day90: '3 Bulan',
                day180: '6 Bulan',
                day365: '1 Tahun',
                filterOptions: 'Opsi Filter',
                includeMinorEdits: 'Sertakan suntingan kecil (< 100 bytes)',
                mainNamespaceOnly: 'Hanya namespace utama (tidak termasuk pembicaraan, halaman pengguna, dll.)',
                warning: 'Durasi lebih lama membutuhkan waktu dan request API lebih banyak',
                analyze: 'Analisis Dampak',
                trending: 'Semua Trending Teratas',
                contributions: 'Kontribusi Anda',
                article: 'Artikel',
                edits: 'Edit',
                bytes: 'Bytes +',
                lastEdited: 'Terakhir Diedit',
                pageviews: 'Pageviews',
                fileUsage: 'Penggunaan File',
                impact: 'Dampak',
                significant: 'Signifikan',
                low: 'Rendah',
                loading: 'Memuat...',
                fetchingTrending: 'Mengambil artikel trending...',
                fetchingContribs: 'Mengambil kontribusi...',
                fetchingFileUsage: 'Mengambil penggunaan file...',
                analyzingArticles: 'Menganalisis artikel',
                noContribs: 'Tidak ada kontribusi ditemukan',
                errorFields: 'Username dan proyek wajib diisi',
                errorTrending: 'Gagal memuat artikel trending',
                totalEdits: 'Total Edit',
                totalArticles: 'Total Artikel',
                totalViews: 'Total Views',
                threshold: 'Threshold signifikan',
                exportPDF: 'Ekspor PDF',
                exportJSON: 'Ekspor JSON',
                noDataToExport: 'Tidak ada data untuk diekspor',
                pages: 'halaman',
                userInfo: 'Informasi Pengguna',
                localInfo: 'Informasi Lokal',
                globalInfo: 'Status Akun Global',
                userId: 'ID Pengguna',
                editCount: 'Jumlah Edit',
                registration: 'Terdaftar',
                groups: 'Grup',
                blocked: 'Diblokir',
                yes: 'Ya',
                no: 'Tidak',
                globalEditCount: 'Total Edit Global',
                homeWiki: 'Wiki Utama',
                mergedWikis: 'Wiki Terhubung',
                activeWikis: 'Wiki Aktif',
                showActiveOnly: 'Tampilkan hanya wiki aktif (edit > 0)',
                generatedFrom: 'Dibuat dari',

            },
            en: {
                title: 'Wikimedia Impact Analyzer',
                backHome: 'Back to Affandy Murad',
                username: 'Wikimedia Username',
                examplePlaceholder: 'Example: Example',
                project: 'Wikimedia Project URL',
                duration: 'Analysis Duration',
                day1: '1 Day',
                day7: '7 Days',
                day30: '30 Days',
                day90: '3 Months',
                day180: '6 Months',
                day365: '1 Year',
                filterOptions: 'Filter Options',
                includeMinorEdits: 'Include minor edits (< 100 bytes)',
                mainNamespaceOnly: 'Main namespace only (exclude talk, user pages, etc.)',
                warning: 'Longer durations will take more time and API requests',
                analyze: 'Analyze Impact',
                trending: 'All Trending Articles',
                contributions: 'Your Contributions',
                article: 'Article',
                edits: 'Edits',
                bytes: 'Bytes +',
                lastEdited: 'Last Edited',
                pageviews: 'Pageviews',
                fileUsage: 'File Usage',
                impact: 'Impact',
                significant: 'Significant',
                low: 'Low',
                loading: 'Loading...',
                fetchingTrending: 'Fetching trending articles...',
                fetchingContribs: 'Fetching contributions...',
                fetchingFileUsage: 'Fetching file usage...',
                analyzingArticles: 'Analyzing articles',
                noContribs: 'No contributions found',
                errorFields: 'Username and project are required',
                errorTrending: 'Failed to load trending articles',
                totalEdits: 'Total Edits',
                totalArticles: 'Total Articles',
                totalViews: 'Total Views',
                threshold: 'Significant threshold',
                exportPDF: 'Export PDF',
                exportJSON: 'Export JSON',
                noDataToExport: 'No data to export',
                pages: 'pages',
                userInfo: 'User Information',
                localInfo: 'Local Information',
                globalInfo: 'Global Account Status',
                userId: 'User ID',
                editCount: 'Edit Count',
                registration: 'Registration',
                groups: 'Groups',
                blocked: 'Blocked',
                yes: 'Yes',
                no: 'No',
                globalEditCount: 'Global Edit Count',
                homeWiki: 'Home Wiki',
                mergedWikis: 'Merged Wikis',
                activeWikis: 'Active Wikis',
                showActiveOnly: 'Show only active wikis (edits > 0)',
                generatedFrom: 'Generated from'
            }
        };

        // Theme functions - Apply immediately before DOM loads
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'system';
            let themeToApply;

            if (savedTheme === 'system') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                themeToApply = isDark ? 'dark' : 'light';
            } else {
                themeToApply = savedTheme;
            }

            document.documentElement.setAttribute('data-theme', themeToApply);
        })();

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            applyTheme(savedTheme);
            updateThemeButtons(savedTheme);
        }

        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
            updateThemeButtons(theme);
        }

        function applyTheme(theme) {
            if (theme === 'system') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
        }

        function updateThemeButtons(theme) {
            const lightBtn = document.getElementById('lightThemeBtn');
            const darkBtn = document.getElementById('darkThemeBtn');

            if (lightBtn && darkBtn) {
                lightBtn.classList.remove('active');
                darkBtn.classList.remove('active');

                if (theme === 'light') {
                    lightBtn.classList.add('active');
                } else if (theme === 'dark') {
                    darkBtn.classList.add('active');
                }
            }
        }

        // Language functions
        function toggleLanguage() {
            currentLang = currentLang === 'id' ? 'en' : 'id';
            localStorage.setItem('language', currentLang);
            updateLanguage();
            if (document.getElementById('resultCard').style.display !== 'none') {
                // Re-render if needed
            }
        }

        function updateLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const translation = translations[currentLang]?.[key];

                if (translation) {
                    el.textContent = translation;
                } else {
                    console.warn(`Missing translation for key: ${key} in language: ${currentLang}`);
                }
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const translation = translations[currentLang]?.[key];
                if (translation) {
                    el.placeholder = translation;
                }
            });

            document.getElementById('langText').textContent = currentLang === 'id' ? 'EN' : 'ID';
            document.documentElement.lang = currentLang;
        }

        // Utility functions
        const normalize = u => u.startsWith('http') ? u.replace(/\/$/, '') : 'https://' + u.replace(/\/$/, '');
        const keyFrom = u => u.replace(/^https?:\/\//, '');
        const fmt = d => new Date(d).toLocaleDateString(currentLang === 'id' ? 'id-ID' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric' });

        // Commons functions
        function isCommonsProject(projectUrl) {
            return projectUrl.includes('commons.wikimedia.org');
        }

        async function fetchFileUsage(filename, proj) {
            try {
                const url = `${proj}/w/api.php?origin=*&action=query&format=json&list=imageusage&iutitle=${encodeURIComponent(filename)}&iulimit=500`;
                const res = await fetch(url);
                const data = await res.json();
                return data.query?.imageusage?.length || 0;
            } catch {
                return 0;
            }
        }

        function isUpload(contrib) {
            return contrib.newpage || (contrib.sizediff && contrib.sizediff > 1000);
        }

        function shouldIncludeContrib(contrib, filters, isCommons) {
            if (isCommons) {
                const title = contrib.title;
                const lower = title.toLowerCase();

                if (lower.startsWith('user:') ||
                    lower.startsWith('user talk:') ||
                    lower.startsWith('talk:') ||
                    lower.startsWith('wikipedia:') ||
                    lower.startsWith('special:')) {
                    return false;
                }

                return true;
            }

            if (!filters.includeMinor && (contrib.minor || (contrib.sizediff && Math.abs(contrib.sizediff) < 100))) {
                return false;
            }

            if (filters.mainNamespaceOnly) {
                if (contrib.title.includes(':')) {
                    const ns = contrib.title.split(':')[0];
                    if (!['File', 'Berkas', 'Category', 'Kategori'].includes(ns)) {
                        return false;
                    }
                }
            }

            return true;
        }

        // Export functions
        let exportData = {
            username: '',
            project: '',
            period: { start: '', end: '', days: 0 },
            userInfo: null,
            summary: { totalEdits: 0, totalArticles: 0, totalViews: 0 },
            articles: []
        };

        function getCurrentPageUrl() {
            return window.location.href.split('?')[0].split('#')[0];
        }

        function exportPDF() {
            if (!exportData.articles.length) {
                alert(translations[currentLang].noDataToExport);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const marginBottom = 20;

            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(`Wikimedia Impact Report`, 14, yPos);
            yPos += 8;

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Username: ${exportData.username}`, 14, yPos);
            yPos += 6;

            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Generated from: ${exportData.pageUrl}`, 14, yPos);
            yPos += 6;
            doc.setFontSize(11);
            doc.setTextColor(0);

            doc.text(
                `Period: ${exportData.period.start} to ${exportData.period.end} (${exportData.period.days} days)`,
                14,
                yPos
            );
            yPos += 8;

            // User Information Section
            if (exportData.userInfo) {
                const ui = exportData.userInfo;

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('User Information', 14, yPos);
                yPos += 7;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');

                // Local Info
                doc.setFont(undefined, 'bold');
                doc.text('Local Account:', 14, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 5;

                doc.text(`User ID: ${ui.local.userId ?? '‚Äî'}`, 20, yPos);
                yPos += 5;
                doc.text(`Edit Count: ${ui.local.editCount?.toLocaleString() ?? '‚Äî'}`, 20, yPos);
                yPos += 5;
                doc.text(`Registration: ${ui.local.registration ? new Date(ui.local.registration).toLocaleDateString() : '‚Äî'}`, 20, yPos);
                yPos += 5;
                doc.text(`Groups: ${ui.local.groups?.join(', ') || 'user'}`, 20, yPos);
                yPos += 5;
                doc.text(`Blocked: ${ui.local.blocked ? 'Yes' : 'No'}`, 20, yPos);
                yPos += 8;

                // Global Info
                if (ui.global) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Global Account:', 14, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;

                    doc.text(`Total Global Edits: ${ui.global.totalEdits.toLocaleString()}`, 20, yPos);
                    yPos += 5;
                    doc.text(`Home Wiki: ${ui.global.homeWiki || '‚Äî'}`, 20, yPos);
                    yPos += 5;
                    doc.text(`Connected Wikis: ${ui.global.totalWikis} (${ui.global.activeWikis} active)`, 20, yPos);
                    yPos += 7;

                    // Merged Wikis sebagai clickable links (horizontal, dipisah koma)
                    if (ui.global.mergedWikis && ui.global.mergedWikis.length > 0) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Active Wikis:', 20, yPos);
                        doc.setFont(undefined, 'normal');
                        yPos += 5;

                        // Filter hanya wiki aktif dan sort by edit count
                        const activeWikis = ui.global.mergedWikis
                            .filter(w => w.editCount > 0)
                            .sort((a, b) => b.editCount - a.editCount);

                        let xPos = 20;
                        const maxWidth = 260; // Lebar maksimal sebelum pindah baris
                        const lineHeight = 5;

                        activeWikis.forEach((wiki, index) => {
                            const wikiText = `${wiki.wiki} (${wiki.editCount.toLocaleString()})`;
                            const separator = index < activeWikis.length - 1 ? ', ' : '';
                            const fullText = wikiText + separator;

                            const textWidth = doc.getTextWidth(fullText);

                            // Cek apakah perlu pindah baris
                            if (xPos + textWidth > maxWidth) {
                                yPos += lineHeight;
                                xPos = 20;
                            }

                            // Tambahkan link clickable
                            doc.setTextColor(13, 110, 253); // Warna biru
                            doc.textWithLink(wikiText, xPos, yPos, {
                                url: `${wiki.url}/wiki/User:${exportData.username}`
                            });

                            xPos += doc.getTextWidth(wikiText);

                            // Tambahkan separator (tidak clickable)
                            if (separator) {
                                doc.setTextColor(0); // Warna hitam untuk separator
                                doc.text(separator, xPos, yPos);
                                xPos += doc.getTextWidth(separator);
                            }
                        });

                        yPos += 10;
                        doc.setTextColor(0); // Reset warna ke hitam
                    } else {
                        yPos += 5;
                    }
                }
            }

            doc.setDrawColor(200);
            doc.line(14, yPos, 280, yPos);
            yPos += 8;

            // Contributions Table
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Contributions Analysis', 14, yPos);
            yPos += 7;

            const isCommons = isCommonsProject(exportData.project);
            const headers = isCommons
                ? [
                    [
                        translations[currentLang].article,
                        translations[currentLang].edits,
                        translations[currentLang].bytes,
                        translations[currentLang].lastEdited,
                        translations[currentLang].pageviews,
                        translations[currentLang].fileUsage,
                        translations[currentLang].impact
                    ]
                ]
                : [
                    [
                        translations[currentLang].article,
                        translations[currentLang].edits,
                        translations[currentLang].bytes,
                        translations[currentLang].lastEdited,
                        translations[currentLang].pageviews,
                        translations[currentLang].impact
                    ]
                ];

            const body = exportData.articles.map(article => {
                const row = [
                    article.title,
                    article.edits,
                    article.bytes,
                    article.lastEdited,
                    article.pageviews.toLocaleString(),
                ];

                if (isCommons) {
                    row.push(`${article.fileUsage} ${translations[currentLang].pages}`);
                }

                row.push(article.impact);
                return row;
            });

            doc.autoTable({
                head: headers,
                body: body,
                startY: yPos,
                theme: 'grid',
                styles: {
                    fontSize: 9,
                    cellPadding: 3,
                    overflow: 'linebreak',
                    halign: 'left'
                },
                headStyles: {
                    fillColor: [13, 110, 253],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                },
                columnStyles: {
                    0: { cellWidth: 60 },
                    2: { halign: 'right' },
                    4: { halign: 'right' },
                    5: isCommons ? { halign: 'right' } : {}
                },
                margin: { top: yPos, left: 14, right: 14, bottom: marginBottom },
                didDrawPage: function (data) {
                    // Footer di setiap halaman
                    const pageCount = doc.internal.getNumberOfPages();
                    const currentPage = doc.internal.getCurrentPageInfo().pageNumber;

                    doc.setFontSize(9);
                    doc.setTextColor(150);
                    doc.text(
                        `Page ${currentPage} of ${pageCount}`,
                        doc.internal.pageSize.width / 2,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
            });

            // Summary di halaman terakhir
            const finalY = doc.lastAutoTable.finalY + 10;

            // Cek apakah summary muat di halaman ini
            if (finalY + 30 > pageHeight - marginBottom) {
                doc.addPage();
                yPos = 20;
            } else {
                yPos = finalY;
            }

            doc.setDrawColor(200);
            doc.line(14, yPos, 280, yPos);
            yPos += 8;

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0);
            doc.text('Summary', 14, yPos);
            yPos += 8;

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(translations[currentLang].totalEdits + ': ' + exportData.summary.totalEdits.toLocaleString(), 14, yPos);
            yPos += 7;
            doc.text(translations[currentLang].totalArticles + ': ' + exportData.summary.totalArticles.toLocaleString(), 14, yPos);
            yPos += 7;
            doc.text(translations[currentLang].totalViews + ': ' + exportData.summary.totalViews.toLocaleString(), 14, yPos);

            yPos += 10;
            doc.setDrawColor(200);
            doc.line(14, yPos, 280, yPos);
            yPos += 8;

            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text('This report was generated from:', 14, yPos);
            yPos += 5;
            doc.setTextColor(13, 110, 253);
            doc.textWithLink(exportData.pageUrl, 14, yPos, { url: exportData.pageUrl });

            const filename = `wikimedia-impact-${exportData.username}-${Date.now()}.pdf`;
            doc.save(filename);
        }

        function exportJSON() {
            if (!exportData.articles.length) {
                alert(translations[currentLang].noDataToExport);
                return;
            }
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, `wikimedia-impact-${exportData.username}-${Date.now()}.json`, 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Table functions
        function updateTableHeaders(isCommons) {
            const t = translations[currentLang] || translations['en'];

            const commonHeaders = `
        <tr>
            <th onclick="sortTable(0)" data-sort-type="text">
                <span>${t.article}</span>
                <span class="sort-icon"></span>
            </th>
            <th onclick="sortTable(1)" data-sort-type="number">
                <span>${t.edits}</span>
                <span class="sort-icon"></span>
            </th>
            <th onclick="sortTable(2)" data-sort-type="number">
                <span>${t.bytes}</span>
                <span class="sort-icon"></span>
            </th>
            <th onclick="sortTable(3)" data-sort-type="date">
                <span>${t.lastEdited}</span>
                <span class="sort-icon"></span>
            </th>
            <th onclick="sortTable(4)" data-sort-type="number">
                <span>${t.pageviews}</span>
                <span class="sort-icon"></span>
            </th>
    `;

            const commonsExtra = isCommons ? `
            <th onclick="sortTable(5)" data-sort-type="number">
                <span>${t.fileUsage}</span>
                <span class="sort-icon"></span>
            </th>
    ` : '';

            const impactHeader = `
            <th onclick="sortTable(${isCommons ? 6 : 5})" data-sort-type="text">
                <span>${t.impact}</span>
                <span class="sort-icon"></span>
            </th>
        </tr>
    `;

            document.getElementById('resultTableHead').innerHTML = commonHeaders + commonsExtra + impactHeader;
        }

        function toggleCollapse(section) {
            const content = document.getElementById(`${section}Content`);
            const icon = document.getElementById(`${section}CollapseIcon`);
            const header = content.previousElementSibling;
            const isCollapsed = content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
            header.setAttribute('aria-expanded', !isCollapsed);
        }

        function debounce(fn, delay = 80) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        }

        const sortTable = debounce(function (columnIndex) {
            const table = document.getElementById('resultTable');
            const tbody = table.querySelector('tbody');
            const headers = table.querySelectorAll('th');

            headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));

            if (currentSortColumn === columnIndex) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortDirection = 'asc';
                currentSortColumn = columnIndex;
            }

            headers[columnIndex].classList.add(`sort-${currentSortDirection}`);

            const sortType = headers[columnIndex].getAttribute('data-sort-type');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();

                if (sortType === 'number') {
                    aVal = parseFloat(aVal.replace(/,/g, '')) || 0;
                    bVal = parseFloat(bVal.replace(/,/g, '')) || 0;
                } else if (sortType === 'date') {
                    aVal = new Date(aVal).getTime() || 0;
                    bVal = new Date(bVal).getTime() || 0;
                }

                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });

            rows.forEach(row => tbody.appendChild(row));
        }, 80);

        async function fetchTrendingWithRetry(key, proj, maxRetry = 10) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < maxRetry; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().slice(0, 10).replace(/-/g, '/');

                try {
                    const url = `https://wikimedia.org/api/rest_v1/metrics/pageviews/top/${key}/all-access/${dateStr}`;
                    const res = await fetch(url, { cache: 'no-cache' });
                    if (!res.ok) continue;
                    const json = await res.json();
                    if (json.items?.[0]?.articles?.length) {
                        /*  return json.items[0].articles.slice(0, 30); */
                        return json.items[0].articles;
                    }
                } catch { }
            }
            return [];
        }

        function updateProgress(done, total) {
            const progress = Math.round((done / total) * 100);
            requestAnimationFrame(() => {
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `${translations[currentLang].analyzingArticles} ${done}/${total} (${progress}%)`;
            });
        }

        function updateSummary(totalEdits, totalArticles, totalViews) {
            document.getElementById('summary').innerHTML = `
                <div class="summary-item">
                    <div class="summary-value">${totalEdits.toLocaleString()}</div>
                    <div class="summary-label">${translations[currentLang].totalEdits}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${totalArticles.toLocaleString()}</div>
                    <div class="summary-label">${translations[currentLang].totalArticles}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${totalViews.toLocaleString()}</div>
                    <div class="summary-label">${translations[currentLang].totalViews}</div>
                </div>
            `;
        }

        async function fetchUserInfo(user, proj) {
            const wiki = proj.replace(/^https?:\/\//, '');

            const localApi = `${proj}/w/api.php?action=query&list=users&ususers=${encodeURIComponent(user)}&usprop=editcount|registration|groups|blockinfo&format=json&origin=*`;
            const globalApi = `${proj}/w/api.php?action=query&meta=globaluserinfo&guiuser=${encodeURIComponent(user)}&guiprop=groups|rights|merged&format=json&origin=*`;

            try {
                const [localRes, globalRes] = await Promise.all([
                    fetch(localApi),
                    fetch(globalApi)
                ]);

                const localData = await localRes.json();
                const globalData = await globalRes.json();

                const userData = localData.query.users[0];
                const globalInfo = globalData.query.globaluserinfo || null;

                return { userData, globalInfo, wiki };
            } catch (err) {
                console.error('Error fetching user info:', err);
                return null;
            }
        }

        function renderUserInfo(data) {
            if (!data) return;

            const { userData, globalInfo, wiki } = data;
            const t = translations[currentLang];

            // Local Info
            const localHtml = `
        <div class="user-info-item">
            <div class="user-info-label">${t.userId}</div>
            <div class="user-info-value">${userData.userid ?? '‚Äî'}</div>
        </div>
        <div class="user-info-item">
            <div class="user-info-label">${t.editCount}</div>
            <div class="user-info-value">${Number.isFinite(userData.editcount) ? userData.editcount.toLocaleString() : '‚Äî'}</div>
        </div>
        <div class="user-info-item">
            <div class="user-info-label">${t.registration}</div>
            <div class="user-info-value">${userData.registration ? new Date(userData.registration).toLocaleDateString(currentLang === 'id' ? 'id-ID' : 'en-US') : '‚Äî'}</div>
        </div>
        <div class="user-info-item">
            <div class="user-info-label">${t.groups}</div>
            <div class="user-info-value">${userData.groups?.length ? userData.groups.join(', ') : 'user'}</div>
        </div>
        <div class="user-info-item">
            <div class="user-info-label">${t.blocked}</div>
            <div class="user-info-value">
                <span class="badge ${userData.blockid ? 'badge-warning' : 'badge-success'}">
                    ${userData.blockid ? t.yes : t.no}
                </span>
            </div>
        </div>
    `;

            document.getElementById('localInfo').innerHTML = localHtml;

            // Global Info
            if (globalInfo) {
                const totalEdits = globalInfo.merged?.reduce((sum, m) => sum + (m.editcount || 0), 0) || 0;
                const activeWikis = globalInfo.merged?.filter(m => m.editcount > 0).length || 0;

                const globalHtml = `
            <div class="user-info-item">
                <div class="user-info-label">${t.globalEditCount}</div>
                <div class="user-info-value">${totalEdits.toLocaleString()}</div>
            </div>
            <div class="user-info-item">
                <div class="user-info-label">${t.homeWiki}</div>
                <div class="user-info-value">${globalInfo.home || '‚Äî'}</div>
            </div>
            <div class="user-info-item">
                <div class="user-info-label">${t.mergedWikis}</div>
                <div class="user-info-value">${globalInfo.merged?.length || 0}</div>
            </div>
            <div class="user-info-item">
                <div class="user-info-label">${t.activeWikis}</div>
                <div class="user-info-value">${activeWikis}</div>
            </div>
        `;

                document.getElementById('globalInfo').innerHTML = globalHtml;

                // Merged Wikis
                if (globalInfo.merged?.length) {
                    const mergedHtml = `
                <h4 style="margin-bottom: 12px; font-size: 16px;">üîó <span data-i18n="mergedWikis">${t.mergedWikis}</span></h4>
                <div style="margin-bottom: 8px;">
                    <label style="font-size: 13px; cursor: pointer;">
                        <input type="checkbox" id="onlyActiveWikis" checked onchange="filterWikiChips()">
                        <span data-i18n="showActiveOnly">${t.showActiveOnly}</span>
                    </label>
                </div>
                <div class="wiki-chip-container" id="wikiChips"></div>
            `;

                    document.getElementById('mergedWikis').innerHTML = mergedHtml;
                    renderWikiChips(globalInfo, userData.name);
                }
            }

            document.getElementById('userInfoCard').style.display = 'block';
        }

        function renderWikiChips(globalInfo, username) {
            const container = document.getElementById('wikiChips');
            if (!container) return;

            const onlyActive = document.getElementById('onlyActiveWikis')?.checked ?? true;

            container.innerHTML = '';

            globalInfo.merged
                .filter(m => !onlyActive || (m.editcount ?? 0) > 0)
                .sort((a, b) => (b.editcount ?? 0) - (a.editcount ?? 0))
                .forEach(m => {
                    const isHome = globalInfo.home === m.wiki;
                    const wikiClass = getWikiClass(m.wiki);

                    const chip = document.createElement('a');
                    chip.className = `wiki-chip ${wikiClass} ${isHome ? 'home' : ''}`;
                    chip.href = `${m.url}/wiki/User:${encodeURIComponent(username)}`;
                    chip.target = '_blank';
                    chip.title = m.groups?.length ? `Groups: ${m.groups.join(', ')}` : 'Standard user';

                    chip.innerHTML = `
                <img src="${m.url}/favicon.ico" alt="" 
                     onerror="this.onerror=null;this.src='https://upload.wikimedia.org/wikipedia/commons/8/8c/Wikimedia-logo_black.svg';">
                <span>${m.wiki}</span>
                ${isHome ? '<span class="badge-mini">HOME</span>' : ''}
                <span>|</span>
                <span>${m.editcount ?? 0} edit</span>
                <span>|</span>
                <span>${m.timestamp?.slice(0, 10) ?? '‚Äî'}</span>
            `;

                    container.appendChild(chip);
                });
        }

        function getWikiClass(wiki) {
            if (wiki.includes('wikipedia.org')) return 'wiki-wikipedia';
            if (wiki.includes('commons.wikimedia.org')) return 'wiki-commons';
            if (wiki.includes('wikidata.org')) return 'wiki-wikidata';
            if (wiki.includes('wikisource.org')) return 'wiki-wikisource';
            return 'wiki-other';
        }

        function filterWikiChips() {
            const globalData = window.cachedGlobalInfo;
            const username = window.cachedUsername;
            if (globalData && username) {
                renderWikiChips(globalData, username);
            }
        }

        async function run() {
            const errorEl = document.getElementById('error');
            const statusEl = document.getElementById('status');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const progressContainer = document.getElementById('progressContainer');

            errorEl.style.display = 'none';
            errorEl.textContent = '';
            progressContainer.style.display = 'none';
            document.getElementById('trendingCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'none';
            document.getElementById('userInfoCard').style.display = 'none';
            document.getElementById('trendingTable').querySelector('tbody').innerHTML = '';
            document.getElementById('resultTable').querySelector('tbody').innerHTML = '';
            document.getElementById('summary').innerHTML = '';

            const user = document.getElementById('username').value.trim();
            const projectInput = document.getElementById('project').value.trim();

            if (!user || !projectInput) {
                errorEl.textContent = translations[currentLang].errorFields;
                errorEl.style.display = 'block';
                return;
            }

            analyzeBtn.disabled = true;

            const days = +document.querySelector('input[name="duration"]:checked').value;
            const threshold = THRESHOLDS[days];
            const proj = normalize(projectInput);
            const key = keyFrom(proj);

            const end = new Date();
            const start = new Date(end);
            start.setDate(end.getDate() - days);

            try {
                // TAMBAHKAN: Fetch user info PERTAMA
                statusEl.textContent = 'Fetching user information...';
                const userInfoData = await fetchUserInfo(user, proj);
                if (userInfoData) {
                    window.cachedGlobalInfo = userInfoData.globalInfo;
                    window.cachedUsername = user;
                    renderUserInfo(userInfoData);

                    // TAMBAHKAN INI: Simpan user info untuk export
                    exportData.userInfo = {
                        local: {
                            userId: userInfoData.userData.userid,
                            editCount: userInfoData.userData.editcount,
                            registration: userInfoData.userData.registration,
                            groups: userInfoData.userData.groups,
                            blocked: userInfoData.userData.blockid ? true : false
                        },
                        global: userInfoData.globalInfo ? {
                            totalEdits: userInfoData.globalInfo.merged?.reduce((sum, m) => sum + (m.editcount || 0), 0) || 0,
                            homeWiki: userInfoData.globalInfo.home,
                            totalWikis: userInfoData.globalInfo.merged?.length || 0,
                            activeWikis: userInfoData.globalInfo.merged?.filter(m => m.editcount > 0).length || 0,
                            mergedWikis: userInfoData.globalInfo.merged?.map(m => ({
                                wiki: m.wiki,
                                url: m.url,
                                editCount: m.editcount,
                                timestamp: m.timestamp,
                                groups: m.groups
                            })) || []
                        } : null
                    };
                }

                // Fetch trending
                statusEl.textContent = translations[currentLang].fetchingTrending;
                const trendingList = await fetchTrendingWithRetry(key, proj);
                if (trendingList.length) {
                    const tbody = document.getElementById('trendingTable').querySelector('tbody');
                    trendingList.forEach(a => {
                        const link = `${proj}/wiki/${encodeURIComponent(a.article)}`;
                        const row = `<tr><td><a href="${link}" target="_blank">${a.article.replace(/_/g, ' ')}</a></td><td>${a.views.toLocaleString()}</td></tr>`;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                    document.getElementById('trendingCard').style.display = 'block';
                    toggleCollapse('trending'); // Langsung collapse saat muncul
                }

                // Fetch contributions
                statusEl.textContent = translations[currentLang].fetchingContribs;
                const ucUrl = `${proj}/w/api.php?origin=*&action=query&format=json&formatversion=2&list=usercontribs&uclimit=500&ucprop=title|timestamp|sizediff|ids|flags&ucuser=${encodeURIComponent(user)}&ucstart=${end.toISOString()}&ucend=${start.toISOString()}`;
                const ucRes = await fetch(ucUrl);
                const ucData = await ucRes.json();
                const contribs = ucData.query?.usercontribs || [];

                if (!contribs.length) {
                    statusEl.textContent = translations[currentLang].noContribs;
                    return;
                }

                const filters = {
                    includeMinor: document.getElementById('includeMinor').checked,
                    mainNamespaceOnly: document.getElementById('mainNamespaceOnly').checked
                };
                const isCommons = isCommonsProject(proj);
                const map = {};

                contribs.forEach(c => {
                    if (!shouldIncludeContrib(c, filters, isCommons)) return;
                    if (!map[c.title]) {
                        map[c.title] = { edits: 0, bytes: 0, last: c.timestamp, revid: c.revid, fileUsage: 0 };
                    }
                    map[c.title].edits++;
                    if (c.sizediff > 0) map[c.title].bytes += c.sizediff;
                    if (new Date(c.timestamp) > new Date(map[c.title].last)) {
                        map[c.title].last = c.timestamp;
                        map[c.title].revid = c.revid;
                    }
                });

                const titles = Object.keys(map);

                // TAMPILKAN PROGRESS BAR SEGERA
                progressContainer.style.display = 'block';
                statusEl.textContent = '';

                // Proses File Usage untuk Commons DENGAN progress bar
                if (isCommons) {
                    for (let i = 0; i < titles.length; i++) {
                        const title = titles[i];
                        map[title].fileUsage = await fetchFileUsage(title, proj);
                        updateProgress(i + 1, titles.length * 2);
                    }
                }

                let done = isCommons ? titles.length : 0;
                let totalViews = 0;


                // UPDATE exportData yang sudah ada:
                exportData.username = user;
                exportData.project = proj;
                exportData.pageUrl = getCurrentPageUrl();
                exportData.period = {
                    start: start.toISOString().split('T')[0],
                    end: end.toISOString().split('T')[0],
                    days
                };
                exportData.summary = {
                    totalEdits: contribs.length,
                    totalArticles: titles.length,
                    totalViews: 0
                };
                exportData.articles = titles.map(t => ({
                    title: t,
                    url: `${proj}/wiki/${encodeURIComponent(t)}`,
                    edits: map[t].edits,
                    bytes: map[t].bytes,
                    lastEdited: map[t].last,
                    pageviews: 0,
                    ...(isCommons ? { fileUsage: map[t].fileUsage } : {}),
                    impact: ''
                }));

                updateTableHeaders(isCommons);
                const tbody = document.getElementById('resultTable').querySelector('tbody');

                // Proses Pageviews
                for (const t of titles) {
                    let views = 0;
                    try {
                        const pvUrl = `https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/${key}/all-access/user/${encodeURIComponent(t)}/daily/${start.toISOString().slice(0, 10).replace(/-/g, '')}/${end.toISOString().slice(0, 10).replace(/-/g, '')}`;
                        const pvRes = await fetch(pvUrl);
                        const pvData = await pvRes.json();
                        views = pvData.items?.reduce((sum, i) => sum + i.views, 0) || 0;
                    } catch { }

                    totalViews += views;
                    done++;
                    const totalSteps = isCommons ? titles.length * 2 : titles.length;
                    updateProgress(done, totalSteps);

                    const impactText = views >= threshold ? translations[currentLang].significant : translations[currentLang].low;
                    const impact = views >= threshold
                        ? `<span class="badge badge-success">${impactText}</span>`
                        : `<span class="badge badge-warning">${impactText}</span>`;
                    const diff = `${proj}/w/index.php?title=${encodeURIComponent(t)}&diff=prev&oldid=${map[t].revid}`;

                    const article = exportData.articles.find(a => a.title === t);
                    if (article) {
                        article.pageviews = views;
                        article.impact = impactText;
                        article.url = `${proj}/wiki/${encodeURIComponent(t)}`;
                    }

                    let rowHtml = `<tr>
                        <td><a href="${proj}/wiki/${encodeURIComponent(t)}" target="_blank">${t}</a></td>
                        <td>${map[t].edits}</td>
                        <td>${map[t].bytes.toLocaleString()}</td>
                        <td><a href="${diff}" target="_blank">${fmt(map[t].last)}</a></td>
                        <td>${views.toLocaleString()}</td>
                    `;
                    rowHtml += isCommons ? `<td>${map[t].fileUsage} ${translations[currentLang].pages}</td>` : '';
                    rowHtml += `<td>${impact}</td></tr>`;
                    tbody.insertAdjacentHTML('beforeend', rowHtml);
                }

                exportData.summary.totalViews = totalViews;
                updateSummary(contribs.length, titles.length, totalViews);
                document.getElementById('resultCard').style.display = 'block';

                if (titles.length === done || (isCommons && done === titles.length * 2)) {
                    setTimeout(() => progressContainer.style.display = 'none', 500);
                }
            } catch (err) {
                console.error(err);
                errorEl.textContent = err.message || 'Terjadi kesalahan saat memproses data';
                errorEl.style.display = 'block';
            } finally {
                analyzeBtn.disabled = false;
                statusEl.textContent = '';
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            updateLanguage();
            initTheme(); // This will also update button states

            document.getElementById('analyzeBtn').addEventListener('click', run);
            document.getElementById('langBtn').addEventListener('click', toggleLanguage);
            document.getElementById('lightThemeBtn').addEventListener('click', () => setTheme('light'));
            document.getElementById('darkThemeBtn').addEventListener('click', () => setTheme('dark'));

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'system' || !savedTheme) {
                    applyTheme('system');
                }
            });
        });
    </script>

</body>

</html>