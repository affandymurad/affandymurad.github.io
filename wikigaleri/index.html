<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foto WikiCommons Terdekat</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #38bdf8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --bg-color: #f9fafb;
            --bg-secondary: #f3f4f6;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 1.8rem;
            text-align: center;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        /* Ganti bagian #controls yang ada dengan ini */
        #controls {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: grid;
            grid-template-columns: repeat(2, auto) 1fr auto;
            gap: 1rem;
            align-items: center;
        }



        @media (max-width: 968px) {
            #controls {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            #check-permission {
                grid-column: 1 / -1;
            }

            .permission-badge {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            #controls {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 0.85rem;
            }

            #language-select,
            #check-permission,
            .permission-badge {
                width: 100%;
                grid-column: 1;
            }

            #check-permission {
                justify-content: center;
            }

            .permission-badge {
                text-align: center;
            }
        }

        #language-select {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            font-family: inherit;
            font-size: 0.95rem;
            background-color: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            flex-grow: 1;
            max-width: 250px;
        }

        button {
            padding: 0.5rem 1.25rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button:active {
            transform: scale(0.98);
        }

        #check-permission::before {
            content: "üìç";
        }

        /* Ganti styling permission status */
        .permission-badge {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .permission-badge.granted {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .permission-badge.denied {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .permission-badge.pending {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        /* Hapus class .permitted, .denied, .pending yang lama */
        /* Tambahkan setelah #location-status */
        .coordinates-display {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-color);
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .coordinates-display::before {
            content: "üìç";
            font-size: 1.2rem;
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
            user-select: none;
            padding: 0.75rem;
            border-radius: var(--radius);
            transition: background-color 0.2s;
            background-color: var(--bg-secondary);
        }

        .location-header:hover {
            background-color: var(--border-color);
        }

        .location-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .toggle-icon {
            font-size: 1rem;
            transition: transform 0.3s ease;
            color: var(--text-light);
            font-weight: bold;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .location-details {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .location-details.hidden {
            max-height: 0;
            opacity: 0;
        }

        #location-status {
            margin-bottom: 1.5rem;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
        }

        #location-status p {
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .location-part {
            margin: 0.75rem 0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: rgba(219, 234, 254, 0.3);
            border-radius: var(--radius);
        }

        .location-part span {
            font-weight: 500;
            margin-right: auto;
        }

        .location-part button {
            padding: 0.3rem 0.75rem;
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            font-size: 0.85rem;
        }

        .location-part button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Update grid results untuk spacing yang lebih baik */
        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.75rem;
            padding: 0;
            list-style: none;
        }

        @media (max-width: 1400px) {
            #results {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            #results {
                grid-template-columns: 1fr;
                gap: 1.25rem;
            }
        }

        /* Ganti .photo-card dan turunannya */
        .photo-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            list-style: none;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border-color);
            height: 100%;
        }

        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        /* Container gambar dengan aspect ratio */
        .photo-image-container {
            position: relative;
            width: 100%;
            padding-top: 66.67%;
            /* Aspect ratio 3:2 */
            overflow: hidden;
            background-color: var(--border-color);
        }

        .photo-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.3s ease;
        }

        .photo-card:hover img {
            transform: scale(1.05);
        }

        /* Stats overlay di pojok kanan atas */
        .photo-stats {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .stat-badge {
            background: rgba(99, 102, 241, 0.95);
            backdrop-filter: blur(8px);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .stat-badge .icon {
            font-size: 0.85rem;
        }

        /* Content area */
        .photo-content {
            padding: 1.25rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Title dengan styling yang lebih prominent */
        .photo-title {
            margin: 0;
            padding: 0;
        }

        .photo-card a.photo-link {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 700;
            font-size: 1.1rem;
            line-height: 1.4;
            display: block;
            transition: color 0.2s;
            margin: 0;
        }

        .photo-card a.photo-link:hover {
            color: var(--primary-color);
        }

        /* Description dengan line clamp */
        .description {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        /* Hapus CSS .distance yang lama, ganti dengan: */
        .distance {
            position: absolute;
            top: 12px;
            left: 12px;
            display: inline-flex;
            align-items: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 6px 12px;
            background: rgba(99, 102, 241, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .distance::before {
            content: "üìç";
            margin-right: 0.4rem;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .distance {
                top: 8px;
                left: 8px;
                padding: 4px 8px;
                font-size: 0.7rem;
            }

            .metadata-toggle:hover {
                margin-left: -1rem;
                margin-right: -1rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        /* Collapsible metadata section */
        .metadata-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            cursor: pointer;
            user-select: none;
            border-top: 1px solid var(--border-color);
            margin-top: 0.75rem;
            transition: background-color 0.2s;
        }

        .metadata-toggle:hover {
            background-color: var(--bg-secondary);
            margin-left: -1.25rem;
            margin-right: -1.25rem;
            padding-left: 1.25rem;
            padding-right: 1.25rem;
        }

        .metadata-toggle-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metadata-toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            color: var(--text-light);
        }

        .metadata-toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .metadata-collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .metadata-collapsible.expanded {
            max-height: 500px;
            opacity: 1;
        }

        /* Update .photo-metadata untuk collapsible */
        .photo-metadata {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-top: 0.75rem;
        }

        .metadata-item {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .metadata-item .icon {
            font-size: 1rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .metadata-label {
            font-weight: 600;
            color: var(--text-color);
            margin-right: 0.25rem;
        }

        .metadata-content {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .metadata-link {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
            word-break: break-word;
        }

        .metadata-link:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .metadata-link::after {
            content: "‚Ä¢";
            margin-left: 0.35rem;
            color: var(--text-light);
        }

        .metadata-link:last-child::after {
            content: "";
            margin: 0;
        }

        /* Versi simple - icon langsung di samping */
        .author {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .author-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .author-info {
            flex: 1;
        }

        .author-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-color);
            margin-right: 0.35rem;
        }

        .author-name {
            color: var(--text-color);
            display: inline;
        }

        .author a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .author a:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        /* Card actions dengan icons */
        .card-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }

        .card-actions button {
            flex: 1;
            padding: 0.65rem 1rem;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .route-btn {
            background-color: var(--accent-color);
        }

        .route-btn:hover {
            background-color: #0ea5e9;
        }

        .google-maps-btn {
            background-color: #34c759;
        }

        .google-maps-btn:hover {
            background-color: #28a745;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .photo-content {
                padding: 1rem;
            }

            .photo-card a.photo-link {
                font-size: 1rem;
            }

            .description {
                font-size: 0.85rem;
                -webkit-line-clamp: 2;
            }

            .card-actions {
                flex-direction: column;
            }

            .card-actions button {
                width: 100%;
            }

            .photo-stats {
                top: 8px;
                right: 8px;
                gap: 6px;
            }

            .stat-badge {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .description {
                -webkit-line-clamp: 2;
                line-clamp: 2;
            }
        }

        /* Loading animation yang lebih menarik */
        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, var(--card-bg), var(--bg-secondary));
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
        }

        .loading::before {
            content: "üì∏";
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
            animation: bounce 1s infinite;
        }

        /* Tambahkan di bagian .loading */
        #progress-text {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 600;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* Error state */
        .error {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem 2rem;
            background-color: rgba(239, 68, 68, 0.1);
            border: 2px dashed var(--danger-color);
            border-radius: var(--radius);
            color: var(--danger-color);
        }

        .error::before {
            content: "‚ö†Ô∏è";
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
        }

        /* Tambahkan setelah .error */
        .error button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .error button:hover {
            background-color: var(--secondary-color);
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .map-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--primary-color);
            color: white;
        }

        .popup-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .close-btn {
            background: none;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
            margin: 0;
        }

        .close-btn:hover {
            opacity: 0.8;
        }

        .map-container {
            width: 80vw;
            max-width: 800px;
            height: 60vh;
            max-height: 600px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .map-container {
                width: 90vw;
                height: 50vh;
            }

            #results {
                grid-template-columns: 1fr;
            }
        }

        /* Empty state styling */
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .empty-state::before {
            content: "üîç";
            font-size: 4rem;
            display: block;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state p {
            color: var(--text-light);
            font-size: 1.1rem;
        }
    </style>
</head>

<body>
    <h1>Foto WikiCommons Terdekat (radius 1km)</h1>

    <section id="control-section" aria-label="Pengaturan">
        <h2>Pengaturan</h2>
        <div id="controls">
            <select id="language-select">
                <option value="id">Bahasa Indonesia (id)</option>
                <option value="en">Bahasa Inggris (en)</option>
                <option value="zh">Bahasa Mandarin (zh)</option>
                <option value="es">Bahasa Spanyol (es)</option>
                <option value="bew">Bahasa Betawi (bew)</option>
            </select>
            <button id="check-permission">Periksa Lokasi & Cari</button>
            <!-- Ganti bagian ini di #controls -->
            <span id="permission-status" class="permission-badge pending">Belum diperiksa</span>
        </div>
    </section>

    <!-- Ganti section #location-section -->
    <section id="location-section" aria-label="Status Lokasi">
        <h2>Status Lokasi</h2>
        <div id="location-status">
            <div class="coordinates-display"></div>
            <div class="location-header" onclick="toggleLocationDetails()">
                <h3>Detail Lokasi</h3>
                <span class="toggle-icon collapsed">‚ñ∂</span>
            </div>
            <div class="location-details hidden" id="location-details-content"></div>
        </div>
    </section>

    <section id="results-section" aria-label="Hasil Pencarian">
        <h2>Hasil Pencarian</h2>
        <ul id="results"></ul>
    </section>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        const languageSelect = document.getElementById('language-select');
        const checkPermissionBtn = document.getElementById('check-permission');
        const permissionStatus = document.getElementById('permission-status');
        const locationStatus = document.getElementById('location-status');
        const resultsList = document.getElementById('results');
        let currentLang = 'id';
        let currentPosition = null;
        const placeholderImage = 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Placeholder_view_vector.svg/1362px-Placeholder_view_vector.svg.png?20220519031949';

        // Tambahkan fungsi ini setelah deklarasi variable
        function toggleLocationDetails() {
            const detailsContent = document.getElementById('location-details-content');
            const toggleIcon = document.querySelector('.toggle-icon');

            detailsContent.classList.toggle('hidden');
            toggleIcon.classList.toggle('collapsed');

            if (detailsContent.classList.contains('hidden')) {
                toggleIcon.textContent = '‚ñ∂';
            } else {
                toggleIcon.textContent = '‚ñº';
            }
        }

        async function checkLocationPermission() {
            if (!navigator.permissions || !navigator.geolocation) {
                permissionStatus.textContent = 'API Izin tidak didukung';
                permissionStatus.className = 'denied';
                return 'denied';
            }
            try {
                const result = await navigator.permissions.query({ name: 'geolocation' });
                updatePermissionStatus(result.state);
                result.onchange = () => {
                    updatePermissionStatus(result.state);
                    if (result.state !== 'granted') {
                        currentPosition = null;
                    }
                };
                return result.state;
            } catch (error) {
                console.error('Error memeriksa izin:', error);
                permissionStatus.textContent = 'Gagal memeriksa izin';
                permissionStatus.className = 'error';
                return 'error';
            }
        }

        // Ganti fungsi updatePermissionStatus
        function updatePermissionStatus(state) {
            permissionStatus.className = 'permission-badge';

            if (currentPosition) {
                permissionStatus.textContent = '‚úì Diizinkan';
                permissionStatus.classList.add('granted');
                return;
            }

            if (state === 'granted') {
                permissionStatus.textContent = '‚úì Diizinkan';
                permissionStatus.classList.add('granted');
            } else if (state === 'denied') {
                permissionStatus.textContent = '‚úó Ditolak';
                permissionStatus.classList.add('denied');
            } else if (state === 'prompt') {
                permissionStatus.textContent = '? Menunggu';
                permissionStatus.classList.add('pending');
            } else {
                permissionStatus.textContent = 'Belum diperiksa';
                permissionStatus.classList.add('pending');
            }
        }

        // Ganti fungsi getLocationDetails
        // Ganti fungsi getLocationDetails dengan versi yang lebih robust
        async function getLocationDetails(lat, lon) {
            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;

                // Fetch dengan timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const nominatimResponse = await fetch(nominatimUrl, {
                    headers: { 'User-Agent': 'WikiCommonsNearby/1.0', 'Accept-Language': currentLang },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                const data = await nominatimResponse.json();
                if (!data.address) {
                    return [{ name: 'Lokasi tidak diketahui', type: 'unknown', wikidataId: null }];
                }

                const { road, postcode, city, state, country, suburb } = data.address;
                const locationParts = [
                    { name: road || '', type: 'road' },
                    { name: postcode || '', type: 'postcode' },
                    { name: suburb || '', type: 'suburb' },
                    { name: city || '', type: 'city' },
                    { name: state || '', type: 'state' },
                    { name: country || '', type: 'country' }
                ].filter(part => part.name);

                // Fetch Wikidata dengan timeout dan parallel execution
                const fetchWithTimeout = (url, timeout = 2000) => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);

                    return fetch(url, { signal: controller.signal })
                        .then(response => {
                            clearTimeout(timeoutId);
                            return response;
                        })
                        .catch(error => {
                            clearTimeout(timeoutId);
                            throw error;
                        });
                };

                const detailedParts = await Promise.allSettled(
                    locationParts.map(async (part) => {
                        if (!part.name || part.type === 'road' || part.type === 'postcode') {
                            return { name: part.name, type: part.type, wikidataId: null };
                        }

                        try {
                            const wikidataUrl = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(part.name)}&format=json&language=${currentLang}&type=item&limit=1&origin=*`;
                            const wikidataResponse = await fetchWithTimeout(wikidataUrl, 2000);
                            const wikidataData = await wikidataResponse.json();
                            const entity = wikidataData.search?.[0];
                            return {
                                name: part.name,
                                type: part.type,
                                wikidataId: entity?.id || null
                            };
                        } catch (error) {
                            console.warn(`Skipping Wikidata for ${part.name}:`, error.message);
                            return { name: part.name, type: part.type, wikidataId: null };
                        }
                    })
                );

                // Filter successful results
                return detailedParts
                    .filter(result => result.status === 'fulfilled')
                    .map(result => result.value)
                    .filter(part => part && part.name);

            } catch (error) {
                console.error('Error mengambil detail lokasi:', error);
                // Return minimal location info instead of failing completely
                return [{
                    name: `Lokasi sekitar ${lat.toFixed(2)}, ${lon.toFixed(2)}`,
                    type: 'approximate',
                    wikidataId: null
                }];
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        }

        // Tambahkan cache di level global
        const photoDetailsCache = new Map();

        async function fetchPhotoDetails(title) {
            // Check cache first
            if (photoDetailsCache.has(title)) {
                return photoDetailsCache.get(title);
            }

            try {
                const url = `https://commons.wikimedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&` +
                    `prop=imageinfo|categories|globalusage&iiprop=url|extmetadata&iiurlwidth=250&gulimit=5&cllimit=5&format=json&origin=*`;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                const data = await response.json();
                const pages = data.query.pages;
                const page = Object.values(pages)[0];

                if (!page || page.missing) {
                    throw new Error('Page not found');
                }

                const imageInfo = page.imageinfo?.[0];
                if (!imageInfo) {
                    throw new Error('No image info');
                }

                const extMetadata = imageInfo.extmetadata || {};

                let author = 'Pembuat tidak diketahui';
                let authorUrl = null;
                if (extMetadata.Artist) {
                    const artistHtml = extMetadata.Artist.value;
                    const linkMatch = artistHtml.match(/href="([^"]+)"/);
                    author = artistHtml.replace(/<[^>]+>/g, '').trim() || 'Pembuat tidak diketahui';
                    authorUrl = linkMatch ? linkMatch[1] : null;
                }

                const globalUsage = page.globalusage || [];
                const fileUsage = globalUsage.slice(0, 3).map(usage => ({
                    title: usage.title,
                    url: `https://${usage.wiki}/wiki/${encodeURIComponent(usage.title)}`
                }));

                const categories = page.categories || [];
                const categoryList = categories.slice(0, 3).map(cat => ({
                    title: cat.title.replace('Category:', ''),
                    url: `https://commons.wikimedia.org/wiki/${encodeURIComponent(cat.title)}`
                }));

                const result = {
                    imageUrl: imageInfo.thumburl || placeholderImage,
                    description: extMetadata.ImageDescription?.value || 'Deskripsi tidak tersedia',
                    author: author,
                    authorUrl: authorUrl,
                    fileUsage: fileUsage,
                    categories: categoryList
                };

                // Cache the result
                photoDetailsCache.set(title, result);
                return result;

            } catch (error) {
                console.error('Error mengambil detail foto:', error);
                const fallback = {
                    imageUrl: placeholderImage,
                    description: 'Gagal memuat deskripsi',
                    author: 'Pembuat tidak diketahui',
                    authorUrl: null,
                    fileUsage: [],
                    categories: []
                };
                photoDetailsCache.set(title, fallback);
                return fallback;
            }
        }

        // Ganti fungsi fetchNearbyPhotos
        async function fetchNearbyPhotos(lat, lon) {
            try {
                resultsList.innerHTML = '<li class="loading">Memuat foto dari Wikimedia Commons...</li>';
                const radius = 1000;
                const url = `https://commons.wikimedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lon}&` +
                    `gsradius=${radius}&gslimit=100&gsnamespace=6&format=json&origin=*`;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.query || !data.query.geosearch) {
                    throw new Error('Invalid response from Wikimedia Commons API');
                }

                return data.query.geosearch;
            } catch (error) {
                console.error('Error fetching nearby photos:', error);

                let errorMessage = 'Gagal memuat foto';
                if (error.name === 'AbortError') {
                    errorMessage = 'Permintaan timeout. Silakan coba lagi.';
                } else if (!navigator.onLine) {
                    errorMessage = 'Tidak ada koneksi internet.';
                } else {
                    errorMessage = `Gagal memuat foto: ${error.message}`;
                }

                resultsList.innerHTML = `<li class="error">${errorMessage}<br><button onclick="searchPhotos()" style="margin-top: 1rem;">Coba Lagi</button></li>`;
                return [];
            }
        }

        // Ganti fungsi displayPhotos dengan batch processing
        async function displayPhotos(photos) {
            resultsList.innerHTML = '';
            if (photos.length === 0) {
                resultsList.innerHTML = '<li class="empty-state"><p>Tidak ada foto ditemukan dalam radius 1km</p></li>';
                return;
            }

            // Show loading with progress
            const loadingLi = document.createElement('li');
            loadingLi.className = 'loading';
            loadingLi.innerHTML = 'Memuat detail foto...<br><span id="progress-text">0 / ' + photos.length + '</span>';
            resultsList.appendChild(loadingLi);

            const progressText = document.getElementById('progress-text');

            // Process in batches of 5 untuk menghindari overload
            const BATCH_SIZE = 5;
            let processedCount = 0;

            for (let i = 0; i < photos.length; i += BATCH_SIZE) {
                const batch = photos.slice(i, i + BATCH_SIZE);

                // Process batch in parallel
                const batchPromises = batch.map(async (photo) => {
                    try {
                        const details = await fetchPhotoDetails(photo.title);
                        const distance = calculateDistance(
                            currentPosition.coords.latitude,
                            currentPosition.coords.longitude,
                            photo.lat,
                            photo.lon
                        );

                        return createPhotoCard(photo, details, distance);
                    } catch (error) {
                        console.error('Error creating card:', error);
                        return null;
                    }
                });

                const cards = await Promise.all(batchPromises);

                // Remove loading on first batch
                if (i === 0) {
                    resultsList.removeChild(loadingLi);
                }

                // Add cards to DOM
                cards.forEach(card => {
                    if (card) {
                        resultsList.appendChild(card);
                        processedCount++;
                        if (progressText) {
                            progressText.textContent = `${processedCount} / ${photos.length}`;
                        }
                    }
                });

                // Small delay between batches to keep UI responsive
                if (i + BATCH_SIZE < photos.length) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
        }

        // Extract card creation ke fungsi terpisah untuk reusability
        function createPhotoCard(photo, details, distance) {
            const li = document.createElement('li');
            li.className = 'photo-card';

            // Image container dengan stats overlay
            const imgContainer = document.createElement('div');
            imgContainer.className = 'photo-image-container';

            const img = document.createElement('img');
            img.src = details.imageUrl;
            img.alt = photo.title.replace('File:', '');
            img.loading = 'lazy';
            img.onerror = () => img.src = placeholderImage;
            imgContainer.appendChild(img);

            // Stats overlay
            const statsDiv = document.createElement('div');
            statsDiv.className = 'photo-stats';

            const usageBadge = document.createElement('div');
            usageBadge.className = 'stat-badge';
            usageBadge.innerHTML = `<span class="icon">üìÑ</span> ${details.fileUsage.length}`;
            usageBadge.title = 'Digunakan di wiki lain';
            statsDiv.appendChild(usageBadge);

            const catBadge = document.createElement('div');
            catBadge.className = 'stat-badge';
            catBadge.innerHTML = `<span class="icon">üè∑Ô∏è</span> ${details.categories.length}`;
            catBadge.title = 'Jumlah kategori';
            statsDiv.appendChild(catBadge);

            // Distance badge di overlay (tambahkan setelah statsDiv)
            const distanceDiv = document.createElement('div');
            distanceDiv.className = 'distance';
            distanceDiv.textContent = `${distance} km`;
            imgContainer.appendChild(distanceDiv);

            imgContainer.appendChild(statsDiv);
            li.appendChild(imgContainer);

            // Content area
            const contentDiv = document.createElement('div');
            contentDiv.className = 'photo-content';

            // Title
            const titleDiv = document.createElement('div');
            titleDiv.className = 'photo-title';
            const link = document.createElement('a');
            link.className = 'photo-link';
            link.href = `https://commons.wikimedia.org/wiki/${encodeURIComponent(photo.title)}`;
            link.textContent = photo.title.replace('File:', '').replace(/\.(jpg|jpeg|png|gif|svg)$/i, '');
            link.target = '_blank';
            titleDiv.appendChild(link);
            contentDiv.appendChild(titleDiv);

            // Collapsible toggle button (langsung setelah title)
            const metadataToggle = document.createElement('div');
            metadataToggle.className = 'metadata-toggle';
            metadataToggle.innerHTML = `
    <div class="metadata-toggle-title">
        <span>üìä</span>
        <span>Detail & Informasi</span>
    </div>
    <span class="metadata-toggle-icon collapsed">‚ñ∂</span>
`;

            // Collapsible content wrapper
            const metadataCollapsible = document.createElement('div');
            metadataCollapsible.className = 'metadata-collapsible';

            // Description (masuk ke dalam collapsible)
            const desc = document.createElement('div');
            desc.className = 'description';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = details.description;
            desc.textContent = tempDiv.textContent || tempDiv.innerText || 'Deskripsi tidak tersedia';
            metadataCollapsible.appendChild(desc);

            // Metadata section
            const metadataDiv = document.createElement('div');
            metadataDiv.className = 'photo-metadata';

            // File usage
            if (details.fileUsage.length > 0) {
                const usageItem = document.createElement('div');
                usageItem.className = 'metadata-item';
                usageItem.innerHTML = '<span class="icon">üîÑ</span>';

                const usageContent = document.createElement('div');
                usageContent.className = 'metadata-content';

                details.fileUsage.forEach(usage => {
                    const usageLink = document.createElement('a');
                    usageLink.className = 'metadata-link';
                    usageLink.href = usage.url;
                    usageLink.textContent = usage.title.length > 30 ? usage.title.substring(0, 30) + '...' : usage.title;
                    usageLink.target = '_blank';
                    usageLink.title = usage.title;
                    usageContent.appendChild(usageLink);
                });

                usageItem.appendChild(usageContent);
                metadataDiv.appendChild(usageItem);
            }

            // Categories
            if (details.categories.length > 0) {
                const catItem = document.createElement('div');
                catItem.className = 'metadata-item';
                catItem.innerHTML = '<span class="icon">üè∑Ô∏è</span>';

                const catContent = document.createElement('div');
                catContent.className = 'metadata-content';

                details.categories.forEach(category => {
                    const catLink = document.createElement('a');
                    catLink.className = 'metadata-link';
                    catLink.href = category.url;
                    catLink.textContent = category.title.length > 25 ? category.title.substring(0, 25) + '...' : category.title;
                    catLink.target = '_blank';
                    catLink.title = category.title;
                    catContent.appendChild(catLink);
                });

                catItem.appendChild(catContent);
                metadataDiv.appendChild(catItem);
            }

            // Masukkan metadata ke dalam collapsible
            metadataCollapsible.appendChild(metadataDiv);

            // Author (masuk ke dalam collapsible)
            const authorDiv = document.createElement('div');
            authorDiv.className = 'author';

            const authorIcon = document.createElement('span');
            authorIcon.className = 'author-icon';
            authorIcon.textContent = 'üë§';
            authorDiv.appendChild(authorIcon);

            const authorInfo = document.createElement('div');
            authorInfo.className = 'author-info';

            const authorLabel = document.createElement('span');
            authorLabel.className = 'author-label';
            authorLabel.textContent = 'Pembuat:';
            authorInfo.appendChild(authorLabel);

            const authorName = document.createElement('span');
            authorName.className = 'author-name';

            if (details.authorUrl) {
                const authorLink = document.createElement('a');
                authorLink.href = details.authorUrl.startsWith('http') ? details.authorUrl : `https://commons.wikimedia.org${details.authorUrl}`;
                authorLink.textContent = details.author;
                authorLink.target = '_blank';
                authorName.appendChild(authorLink);
            } else {
                authorName.textContent = details.author;
            }

            authorInfo.appendChild(authorName);
            authorDiv.appendChild(authorInfo);
            metadataCollapsible.appendChild(authorDiv);

            // Toggle functionality
            metadataToggle.onclick = () => {
                const icon = metadataToggle.querySelector('.metadata-toggle-icon');
                metadataCollapsible.classList.toggle('expanded');
                icon.classList.toggle('collapsed');
            };

            // Tambahkan ke contentDiv
            contentDiv.appendChild(metadataToggle);
            contentDiv.appendChild(metadataCollapsible);

            // Actions (tetap di luar collapsible, langsung setelah metadataCollapsible)
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'card-actions';
            // ... (kode actions seperti biasa)

            const routeBtn = document.createElement('button');
            routeBtn.className = 'route-btn';
            routeBtn.innerHTML = 'üó∫Ô∏è Rute';
            routeBtn.onclick = () => showRoutePopup(
                currentPosition.coords.latitude,
                currentPosition.coords.longitude,
                photo.lat,
                photo.lon,
                photo.title.replace('File:', '')
            );
            actionsDiv.appendChild(routeBtn);

            const googleMapsBtn = document.createElement('button');
            googleMapsBtn.className = 'google-maps-btn';
            googleMapsBtn.innerHTML = 'üåç Maps';
            googleMapsBtn.onclick = () => window.open(
                `https://www.google.com/maps?q=${photo.lat},${photo.lon}`,
                '_blank'
            );
            actionsDiv.appendChild(googleMapsBtn);

            contentDiv.appendChild(actionsDiv);
            li.appendChild(contentDiv);

            return li;
        }

        function showRoutePopup(startLat, startLon, endLat, endLon, title) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            document.body.appendChild(overlay);

            const popup = document.createElement('div');
            popup.className = 'map-popup';

            const popupHeader = document.createElement('div');
            popupHeader.className = 'popup-header';

            const popupTitle = document.createElement('div');
            popupTitle.className = 'popup-title';
            popupTitle.textContent = `Rute ke ${title}`;
            popupHeader.appendChild(popupTitle);

            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.className = 'close-btn';
            closeBtn.onclick = () => {
                document.body.removeChild(popup);
                document.body.removeChild(overlay);
            };
            popupHeader.appendChild(closeBtn);

            popup.appendChild(popupHeader);

            const mapContainer = document.createElement('div');
            mapContainer.className = 'map-container';
            popup.appendChild(mapContainer);

            document.body.appendChild(popup);

            const map = L.map(mapContainer).setView([startLat, startLon], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);

            setTimeout(() => {
                map.invalidateSize();
            }, 100);

            const startMarker = L.marker([startLat, startLon]).addTo(map)
                .bindPopup('Lokasi Anda');
            const endMarker = L.marker([endLat, endLon]).addTo(map)
                .bindPopup(title);

            L.Routing.control({
                waypoints: [
                    L.latLng(startLat, startLon),
                    L.latLng(endLat, endLon)
                ],
                routeWhileDragging: false,
                show: true,
                lineOptions: {
                    styles: [{ color: 'blue', weight: 4 }]
                },
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                fitSelectedRoutes: true,
                showAlternatives: false
            }).addTo(map);
        }

        async function fetchWikivoyageSitelink(qid, lang) {
            try {
                const url = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${qid}&format=json&props=sitelinks&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                const entity = data.entities[qid];
                const sitelinks = entity?.sitelinks || {};
                const wikivoyageKey = `${lang}wikivoyage`;
                const sitelink = sitelinks[wikivoyageKey]?.title || null;
                return sitelink ? `https://${lang}.wikivoyage.org/wiki/${encodeURIComponent(sitelink)}` : null;
            } catch (error) {
                console.error(`Error fetching Wikivoyage sitelink for ${qid}:`, error);
                return null;
            }
        }

        // Ganti fungsi updateLocationDisplay
        async function updateLocationDisplay(lat, lon, locationParts) {
            const coordsDisplay = document.querySelector('.coordinates-display');
            coordsDisplay.textContent = `Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;

            const detailsContent = document.getElementById('location-details-content');
            detailsContent.innerHTML = '';

            for (const part of locationParts) {
                const div = document.createElement('div');
                div.className = 'location-part';
                const span = document.createElement('span');
                const labels = {
                    'road': 'Jalan',
                    'postcode': 'Kode Pos',
                    'suburb': 'Kelurahan',
                    'city': 'Kota',
                    'state': 'Provinsi',
                    'country': 'Negara'
                };
                span.textContent = `${labels[part.type] || part.type}: ${part.name}`;
                div.appendChild(span);

                if (part.type !== 'road' && part.type !== 'postcode') {
                    const wdBtn = document.createElement('button');
                    wdBtn.textContent = part.wikidataId ? `Wikidata (${part.wikidataId})` : 'Wikidata (T/A)';
                    wdBtn.onclick = () => {
                        if (part.wikidataId) {
                            window.open(`https://www.wikidata.org/wiki/${part.wikidataId}`, '_blank');
                        } else {
                            window.open(`https://www.wikidata.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                        }
                    };
                    div.appendChild(wdBtn);

                    const wvBtn = document.createElement('button');
                    wvBtn.textContent = 'Wikivoyage';
                    wvBtn.onclick = async () => {
                        if (part.wikidataId) {
                            const directLink = await fetchWikivoyageSitelink(part.wikidataId, currentLang);
                            if (directLink) {
                                window.open(directLink, '_blank');
                            } else {
                                window.open(`https://${currentLang}.wikivoyage.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                            }
                        } else {
                            window.open(`https://${currentLang}.wikivoyage.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                        }
                    };
                    div.appendChild(wvBtn);
                }

                detailsContent.appendChild(div);
            }
        }

        // Ganti fungsi getLocation
        async function getLocation() {
            if (!navigator.geolocation) {
                const coordsDisplay = document.querySelector('.coordinates-display');
                coordsDisplay.textContent = 'Geolokasi tidak didukung oleh browser Anda';
                coordsDisplay.style.color = 'var(--danger-color)';
                updatePermissionStatus('denied');
                return;
            }

            const coordsDisplay = document.querySelector('.coordinates-display');
            coordsDisplay.textContent = 'Mengambil lokasi Anda...';
            coordsDisplay.style.color = 'var(--text-color)';

            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            currentPosition = position;
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;

                            updatePermissionStatus('granted');

                            // Update coordinates display immediately
                            coordsDisplay.textContent = `Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;

                            // Get location details with timeout
                            let locationParts = [];
                            try {
                                coordsDisplay.textContent = `Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)} - Mengambil detail lokasi...`;
                                locationParts = await Promise.race([
                                    getLocationDetails(lat, lon),
                                    new Promise((_, reject) =>
                                        setTimeout(() => reject(new Error('Location details timeout')), 10000)
                                    )
                                ]);
                                await updateLocationDisplay(lat, lon, locationParts);
                            } catch (error) {
                                console.warn('Error getting location details:', error);
                                // Continue even if location details fail
                                coordsDisplay.textContent = `Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                                const detailsContent = document.getElementById('location-details-content');
                                detailsContent.innerHTML = '<p style="color: var(--warning-color); padding: 0.5rem;">Gagal memuat detail lokasi, melanjutkan pencarian foto...</p>';
                            }

                            // Fetch photos
                            try {
                                const photos = await fetchNearbyPhotos(lat, lon);
                                await displayPhotos(photos);
                            } catch (error) {
                                console.error('Error fetching photos:', error);
                                resultsList.innerHTML = `<li class="error">Gagal memuat foto: ${error.message}</li>`;
                            }

                            resolve();
                        } catch (error) {
                            console.error('Error in getLocation:', error);
                            coordsDisplay.textContent = `Error: ${error.message}`;
                            coordsDisplay.style.color = 'var(--danger-color)';
                            reject(error);
                        }
                    },
                    (error) => {
                        let errorMessage = 'Gagal mendapatkan lokasi';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Izin lokasi ditolak. Silakan izinkan akses lokasi di pengaturan browser.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Informasi lokasi tidak tersedia.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Permintaan lokasi timeout. Silakan coba lagi.';
                                break;
                        }

                        coordsDisplay.textContent = errorMessage;
                        coordsDisplay.style.color = 'var(--danger-color)'; //disini
                        updatePermissionStatus('denied');
                        console.error('Geolocation error:', error);
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000, // Increase timeout to 15 seconds
                        maximumAge: 0
                    }
                );
            });
        }

        // Ganti fungsi searchPhotos
        async function searchPhotos() {
            try {
                const permissionState = await checkLocationPermission();

                if (permissionState === 'denied') {
                    alert('Izin lokasi ditolak. Harap izinkan akses lokasi untuk menggunakan fitur ini.');
                    return;
                }

                if (permissionState === 'granted' && currentPosition) {
                    const lat = currentPosition.coords.latitude;
                    const lon = currentPosition.coords.longitude;

                    // Update UI immediately
                    const coordsDisplay = document.querySelector('.coordinates-display');
                    coordsDisplay.textContent = 'Memperbarui data...';

                    try {
                        const locationParts = await Promise.race([
                            getLocationDetails(lat, lon),
                            new Promise((_, reject) =>
                                setTimeout(() => reject(new Error('Timeout')), 8000)
                            )
                        ]);
                        await updateLocationDisplay(lat, lon, locationParts);
                    } catch (error) {
                        console.warn('Location details timeout, continuing with photos...');
                        coordsDisplay.textContent = `Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    }

                    const photos = await fetchNearbyPhotos(lat, lon);
                    await displayPhotos(photos);
                } else {
                    await getLocation();
                }
            } catch (error) {
                console.error('Error in searchPhotos:', error);
                const coordsDisplay = document.querySelector('.coordinates-display');
                if (coordsDisplay) {
                    coordsDisplay.textContent = `Error: ${error.message}`;
                    coordsDisplay.style.color = 'var(--danger-color)';
                }
            }
        }

        languageSelect.addEventListener('change', () => {
            currentLang = languageSelect.value;
            if (currentPosition) {
                searchPhotos();
            }
        });

        checkPermissionBtn.addEventListener('click', async () => {
            await searchPhotos();
        });

        // Ganti window.onload
        window.onload = async () => {
            try {
                const initialPermission = await checkLocationPermission();

                // Don't auto-fetch on load, let user click the button
                console.log('WikiCommons Nearby ready. Permission:', initialPermission);

                // Optional: uncomment if you want auto-load on granted permission
                // if (initialPermission === 'granted') {
                //     await getLocation();
                // }
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        };
    </script>
</body>

</html>