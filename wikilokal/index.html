<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artikel WikiLokal Terdekat</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #38bdf8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] {
            --primary-color: #60a5fa;
            --secondary-color: #3b82f6;
            --accent-color: #38bdf8;
            --text-color: #f3f4f6;
            --text-light: #d1d5db;
            --bg-color: #111827;
            --card-bg: #1f2937;
            --border-color: #374151;
        }

        /* ‚úÖ Fix Leaflet Routing Machine colors in dark mode */
        [data-theme="dark"] .leaflet-routing-container {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }

        [data-theme="dark"] .leaflet-routing-container * {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .leaflet-routing-alt,
        [data-theme="dark"] .leaflet-routing-alt * {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .leaflet-routing-collapse-btn {
            background-color: var(--primary-color) !important;
            color: #fff !important;
        }

        [data-theme="dark"] .leaflet-routing-container a {
            color: var(--accent-color) !important;
        }

        [data-theme="dark"] .leaflet-routing-container a:hover {
            color: var(--primary-color) !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 1.8rem;
            text-align: center;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        /* Header dengan logo */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 250px;
        }

        .wiki-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .header-title h1 {
            margin: 0;
            border: none;
            padding: 0;
            font-size: 1.4rem;
        }

        .header-title p {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .header-right {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Settings Panel */
        .settings-panel {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .settings-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .settings-row:last-child {
            margin-bottom: 0;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex: 1;
            min-width: 200px;
        }

        .setting-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select,
        input[type="color"] {
            padding: 0.6rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            font-family: inherit;
            font-size: 0.95rem;
            background-color: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            width: 100%;
            transition: border-color 0.2s;
        }

        select:hover,
        input[type="color"]:hover {
            border-color: var(--primary-color);
        }

        select:focus,
        input[type="color"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Theme selector */
        .theme-selector {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .theme-btn {
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
            min-width: 80px;
        }

        .theme-btn:hover {
            border-color: var(--primary-color);
        }

        .theme-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        button {
            padding: 0.6rem 1.25rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button:active {
            transform: scale(0.98);
        }

        #check-permission::before {
            content: "üìç";
        }

        #permission-status {
            padding: 0.6rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }

        .permitted {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .denied {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .pending {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        #location-status {
            margin-bottom: 1.5rem;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
        }

        #location-status p {
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .location-part {
            margin: 0.75rem 0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: rgba(37, 99, 235, 0.1);
            border-radius: var(--radius);
        }

        .location-part span {
            font-weight: 500;
            margin-right: auto;
        }

        .location-part button {
            padding: 0.3rem 0.75rem;
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            font-size: 0.85rem;
        }

        .location-part button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        [data-theme="dark"] .location-part button {
            background-color: var(--card-bg);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        [data-theme="dark"] .location-part button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .coord-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }

        .coord-link:hover {
            color: var(--secondary-color);
        }

        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.25rem;
            padding: 0;
            list-style: none;
        }

        .article-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .article-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            border-color: var(--primary-color);
        }

        .article-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .article-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .article-card a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            display: block;
            transition: color 0.2s;
        }

        .article-card a:hover {
            color: var(--secondary-color);
        }

        .description {
            font-size: 0.9rem;
            color: var(--text-color);
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 10;
            line-clamp: 10;
            -webkit-box-orient: vertical;
            position: relative;
        }

        /* Wiktionary words dalam deskripsi */
        .description .wikt-word {
            background-color: rgba(37, 99, 235, 0.15);
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            color: var(--primary-color);
        }

        .description .wikt-word:hover {
            background-color: rgba(37, 99, 235, 0.25);
        }

        .distance {
            display: inline-flex;
            align-items: center;
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            background-color: rgba(37, 99, 235, 0.1);
            border-radius: 100px;
        }

        .distance::before {
            content: "üìç";
            margin-right: 0.5rem;
        }

        .wikidata {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .wikidata a {
            font-size: 0.85rem;
            color: var(--primary-color);
            text-decoration: none;
        }

        .wikidata a:hover {
            color: var(--secondary-color);
        }

        .card-actions {
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .route-btn {
            background-color: var(--accent-color);
            flex: 1;
        }

        .route-btn::before {
            content: "üó∫Ô∏è";
            margin-right: 0.5rem;
        }

        /* Search section */
        .search-filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .search-filter-section h2 {
            margin: 0;
            white-space: nowrap;
        }

        /* Modal untuk Panduan */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            animation: fadeIn 0.3s ease-in;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: none;
            color: var(--text-color);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
        }

        .modal-close:hover {
            opacity: 0.7;
        }

        .guide-section {
            margin-bottom: 1.5rem;
        }

        .guide-section h3 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.1rem;
        }

        .guide-section p {
            margin: 0.5rem 0;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .guide-section ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .guide-section li {
            margin: 0.25rem 0;
            font-size: 0.95rem;
        }

        .google-maps-btn {
            background-color: #34c759;
            flex: 1;
        }

        .google-maps-btn::before {
            content: "üåç";
            margin-right: 0.5rem;
        }

        .loading,
        .error {
            text-align: center;
            padding: 2rem;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .loading {
            color: var(--text-light);
            animation: pulse 1.5s infinite;
        }

        .error {
            color: var(--danger-color);
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .map-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--primary-color);
            color: white;
        }

        .popup-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .close-btn {
            background: none;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
            margin: 0;
        }

        .close-btn:hover {
            opacity: 0.8;
        }

        .map-container {
            width: 80vw;
            max-width: 800px;
            height: 60vh;
            max-height: 600px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .header-top {
                flex-direction: column;
            }

            .header-left {
                width: 100%;
                min-width: unset;
            }

            .header-right {
                width: 100%;
                justify-content: center;
            }

            .settings-row {
                flex-direction: column;
            }

            .setting-group {
                min-width: unset;
                width: 100%;
            }

            .search-filter-section {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-box {
                width: 100%;
            }

            .article-card {
                flex-direction: column;
            }

            .article-card img {
                width: 100%;
                height: 180px;
                border-right: none;
            }

            .article-content {
                padding: 1.5rem;
            }

            #results {
                grid-template-columns: 1fr;
            }

            .map-container {
                width: 90vw;
                height: 50vh;
            }

            .theme-selector {
                flex-direction: column;
                width: 100%;
            }

            .theme-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Header dengan Logo -->
    <div class="header-top">
        <div class="header-left">
            <div class="wiki-logo">W</div>
            <div class="header-title">
                <h1 id="main-title">Artikel WikiLokal Terdekat</h1>
                <p id="main-subtitle">Jelajahi Wikipedia dalam radius 3km dari lokasi Anda</p>
            </div>
        </div>
        <div class="header-right">
            <button id="guide-btn" title="Lihat panduan">üìñ Panduan</button>
            <span id="permission-status" class="pending">Memeriksa izin...</span>
            <button id="check-permission">Cari Artikel</button>
        </div>
    </div>

    <!-- Settings Panel -->
    <section class="settings-panel" aria-label="Pengaturan">
        <div class="settings-row">
            <div class="setting-group">
                <label id="label-theme">Tema</label>
                <div class="theme-selector">
                    <button class="theme-btn active" data-theme="light" id="theme-light">‚òÄÔ∏è Light</button>
                    <button class="theme-btn" data-theme="dark" id="theme-dark">üåô Dark</button>
                    <button class="theme-btn" data-theme="system" id="theme-system">üñ•Ô∏è System</button>
                </div>
            </div>
            <div class="setting-group">
                <label id="label-language">Bahasa</label>
                <select id="language-select">
                    <option value="id">Bahasa Indonesia (ID)</option>
                    <option value="ms">Bahasa Melayu (MS)</option>
                    <option value="en">Bahasa Inggris (EN)</option>
                    <option value="bew">Bahasa Betawi (BEW)</option>
                </select>
            </div>
        </div>
    </section>

    <!-- Location Status Section -->
    <section id="location-section" aria-label="Status Lokasi">
        <h2 id="location-title">Status Lokasi</h2>
        <div id="location-status"></div>
    </section>

    <!-- Results Section -->
    <section id="results-section" aria-label="Hasil Pencarian">
        <h2 id="results-title">Hasil Pencarian</h2>
        <ul id="results"></ul>
    </section>

    <!-- Modal Panduan -->
    <div id="guide-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="guide-title">üìñ Panduan Penggunaan</h2>
                <button class="modal-close">&times;</button>
            </div>

            <!-- Section 0: Penafian Lokasi -->
            <div class="guide-section" data-section="disclaimer">
                <h3 id="guide-disclaimer-title">‚ö†Ô∏è Penafian Penggunaan Lokasi</h3>
                <p id="guide-disclaimer-how"><strong id="guide-disclaimer-how-title">Bagaimana Wikilokal Menggunakan
                        Lokasi Anda:</strong></p>
                <p id="guide-disclaimer-how-desc">Wikilokal hanya menggunakan koordinat lokasi Anda
                    <strong>sementara</strong> untuk menemukan artikel Wikipedia, Wikivoyage, dan Wiktionary yang
                    memiliki data geografis di sekitar Anda. Data lokasi <strong>tidak disimpan</strong> dan
                    <strong>tidak dibagikan</strong> ke pihak lain.
                </p>

                <br />
                <p id="guide-disclaimer-warning-title"><strong>‚ö†Ô∏è Peringatan Penting:</strong></p>
                <p id="guide-disclaimer-warning-desc">Hati-hati saat mengambil screenshot atau memotret layar. Alamat
                    lengkap Anda mungkin terlihat dan dapat mengungkap lokasi Anda saat ini.</p>

                <p id="guide-disclaimer-use-title"><strong id="guide-disclaimer-use-strong">Gunakan fitur ini hanya
                        saat:</strong></p>
                <ul>
                    <li id="guide-disclaimer-use-safe">Anda berada di tempat yang aman</li>
                    <li id="guide-disclaimer-use-conducive">Kondisi memungkinkan untuk berbagi lokasi</li>
                </ul>

                <br />
                <p id="guide-disclaimer-privacy-title"><strong>üîí Privasi Anda:</strong></p>
                <ul>
                    <li id="guide-disclaimer-privacy-law">Mematuhi hukum dan ketentuan privasi yang berlaku</li>
                    <li id="guide-disclaimer-privacy-temp">Menggunakan data lokasi hanya untuk keperluan pencarian
                        artikel</li>
                    <li id="guide-disclaimer-privacy-no-save">Tidak menyimpan riwayat lokasi Anda</li>
                </ul>
            </div>

            <br />

            <!-- Section 1: Fitur Utama -->
            <div class="guide-section" data-section="features">
                <h3 id="guide-features-title">üéØ Fitur Utama</h3>
                <ul>
                    <li>
                        <strong id="guide-search-title">Cari Artikel:</strong>
                        <span id="guide-search-desc">Klik tombol untuk menemukan artikel Wikipedia di sekitar lokasi
                            Anda (radius 3km)</span>
                    </li>
                    <li>
                        <strong id="guide-route-title">Rute:</strong>
                        <span id="guide-route-desc">Lihat petunjuk arah ke lokasi artikel menggunakan Leaflet
                            Routing</span>
                    </li>
                    <li>
                        <strong id="guide-wikt-title">Wiktionary:</strong>
                        <span id="guide-wikt-desc">Klik kata dalam deskripsi untuk mencari definisi</span>
                    </li>
                </ul>
            </div>

            <!-- Section 3: Pengaturan -->
            <div class="guide-section" data-section="settings">
                <h3 id="guide-settings-title">üåç Pengaturan</h3>
                <ul>
                    <li>
                        <strong id="guide-theme-title">Tema:</strong>
                        <span id="guide-theme-desc">Pilih tema Light, Dark, atau ikuti preferensi sistem</span>
                    </li>
                    <li>
                        <strong id="guide-lang-title">Bahasa:</strong>
                        <span id="guide-lang-desc">Ubah bahasa untuk menampilkan konten dalam bahasa pilihan</span>
                    </li>
                </ul>
            </div>

            <!-- Section 4: Lokasi & Konten -->
            <div class="guide-section" data-section="location">
                <h3 id="guide-location-title">üìç Lokasi & Konten</h3>
                <p id="guide-location-desc">Aplikasi menampilkan artikel dari Wikipedia dalam radius 3km dari lokasi
                    Anda. Setiap artikel menampilkan:</p>
                <ul>
                    <li id="guide-content-image">Gambar sampul dari Wikipedia</li>
                    <li id="guide-content-desc">Deskripsi singkat (kata-kata interaktif ke Wiktionary)</li>
                    <li id="guide-content-distance">Jarak dari lokasi Anda</li>
                    <li id="guide-content-wikidata">ID Wikidata untuk referensi lebih lanjut</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        // Translations
        const translations = {
            id: {
                mainTitle: 'Artikel WikiLokal Terdekat',
                mainSubtitle: 'Jelajahi Wikipedia dalam radius 3km dari lokasi Anda',
                theme: 'Tema',
                language: 'Bahasa',
                locationTitle: 'Status Lokasi',
                resultsTitle: 'Hasil Pencarian',
                checkLocation: 'Cari Artikel',
                coordinates: 'Koordinat',
                road: 'Jalan',
                postcode: 'Kode Pos',
                suburb: 'Kelurahan',
                city: 'Kota',
                state: 'Provinsi',
                country: 'Negara',
                wikidata: 'Wikidata',
                wikivoyage: 'Wikivoyage',
                showRoute: 'Tampilkan Rute',
                openMaps: 'Buka di Google Maps',
                distance: 'km jauhnya',
                loading: 'Memuat artikel...',
                noArticles: 'Tidak ada artikel ditemukan dalam radius 3km',
                description: 'Deskripsi tidak tersedia',
                failedLoad: 'Gagal memuat deskripsi',
                permissionGranted: 'diizinkan',
                permissionDenied: 'ditolak',
                permissionPending: 'menunggu',
                locationPermission: 'Izin lokasi: ',
                routeTo: 'Rute ke ',
                gettingLocation: 'Mengambil lokasi Anda...',
                failedLocation: 'Gagal mendapatkan lokasi: ',
                guideBtn: 'Apa ini?',
                guideBtnTitle: 'Lihat panduan',
                checkingPermission: 'Memeriksa izin...',
                searchArticles: 'Cari Artikel',

                // Modal Guide
                guideTitle: 'üìñ Panduan Penggunaan',
                guideMainFeatures: 'üéØ Fitur Utama',
                guideSearchArticle: 'Cari Artikel:',
                guideSearchDesc: 'Klik tombol untuk menemukan artikel Wikipedia di sekitar lokasi Anda (radius 3km)',
                guideRoute: 'Rute:',
                guideRouteDesc: 'Lihat petunjuk arah ke lokasi artikel menggunakan Leaflet Routing',
                guideWiktionary: 'Wiktionary:',
                guideWiktionaryDesc: 'Klik kata dalam deskripsi untuk mencari definisi',
                guideSearchFilter: 'üîç Pencarian & Penyaringan',
                guideSearchBox: 'Kotak Pencarian:',
                guideSearchBoxDesc: 'Cari artikel berdasarkan nama/judul',
                guideSorting: 'Pengurutan:',
                guideSortingDesc: 'Urutkan hasil berdasarkan jarak terdekat atau nama',
                guideSettings: 'üåç Pengaturan',
                guideTheme: 'Tema:',
                guideThemeDesc: 'Pilih tema Light, Dark, atau ikuti preferensi sistem',
                guideLanguage: 'Bahasa:',
                guideLanguageDesc: 'Ubah bahasa untuk menampilkan konten dalam bahasa pilihan',
                guideLocationContent: 'üìç Lokasi & Konten',
                guideLocationContentDesc: 'Aplikasi menampilkan artikel dari Wikipedia dalam radius 3km dari lokasi Anda. Setiap artikel menampilkan:',
                guideContentImage: 'Gambar sampul dari Wikipedia',
                guideContentDescription: 'Deskripsi singkat (kata-kata interaktif ke Wiktionary)',
                guideContentDistance: 'Jarak dari lokasi Anda',
                guideContentWikidata: 'ID Wikidata untuk referensi lebih lanjut',

                // Tambahkan di akhir object translations.id (sebelum kurung kurawal penutup)
                guideDisclaimerTitle: '‚ö†Ô∏è Penafian Penggunaan Lokasi',
                guideDisclaimerHow: 'Bagaimana Wikilokal Menggunakan Lokasi Anda:',
                guideDisclaimerHowDesc: 'Wikilokal hanya menggunakan koordinat lokasi Anda sementara untuk menemukan artikel Wikipedia, Wikivoyage, dan Wiktionary yang memiliki data geografis di sekitar Anda. Data lokasi tidak disimpan dan tidak dibagikan ke pihak lain.',
                guideDisclaimerWarningTitle: '‚ö†Ô∏è Peringatan Penting:',
                guideDisclaimerWarningDesc: 'Hati-hati saat mengambil screenshot atau memotret layar. Alamat lengkap Anda mungkin terlihat dan dapat mengungkap lokasi Anda saat ini.',
                guideDisclaimerUseTitle: 'Gunakan fitur ini hanya saat:',
                guideDisclaimerUseSafe: 'Anda berada di tempat yang aman',
                guideDisclaimerUseConducive: 'Kondisi memungkinkan untuk berbagi lokasi',
                guideDisclaimerPrivacyTitle: 'üîí Privasi Anda:',
                guideDisclaimerPrivacyLaw: 'Mematuhi hukum dan ketentuan privasi yang berlaku',
                guideDisclaimerPrivacyTemp: 'Menggunakan data lokasi hanya untuk keperluan pencarian artikel',
                guideDisclaimerPrivacyNoSave: 'Tidak menyimpan riwayat lokasi Anda'
            },
            ms: {
                mainTitle: 'Artikel WikiLokal Terdekat',
                mainSubtitle: 'Jelajahi Wikipedia dalam radius 3km dari lokasi Anda',
                theme: 'Tema',
                language: 'Bahasa',
                locationTitle: 'Status Lokasi',
                resultsTitle: 'Hasil Carian',
                checkLocation: 'Cari Artikel',
                coordinates: 'Koordinat',
                road: 'Jalan',
                postcode: 'Kod Pos',
                suburb: 'Kampung',
                city: 'Kota',
                state: 'Negeri',
                country: 'Negara',
                wikidata: 'Wikidata',
                wikivoyage: 'Wikivoyage',
                showRoute: 'Papar Laluan',
                openMaps: 'Buka di Google Maps',
                distance: 'km jauhnya',
                loading: 'Memuatkan artikel...',
                noArticles: 'Tiada artikel dijumpai dalam radius 3km',
                description: 'Penerangan tidak tersedia',
                failedLoad: 'Gagal memuatkan penerangan',
                permissionGranted: 'dibenarkan',
                permissionDenied: 'ditolak',
                permissionPending: 'menunggu',
                locationPermission: 'Kebenaran lokasi: ',
                routeTo: 'Laluan ke ',
                gettingLocation: 'Mendapatkan lokasi Anda...',
                failedLocation: 'Gagal mendapatkan lokasi: ',
                guideBtn: 'Apa ini?',
                guideBtnTitle: 'Lihat panduan',
                checkingPermission: 'Memeriksa kebenaran...',
                searchArticles: 'Cari Artikel',

                // Modal Guide
                guideTitle: 'üìñ Panduan Penggunaan',
                guideMainFeatures: 'üéØ Ciri Utama',
                guideSearchArticle: 'Cari Artikel:',
                guideSearchDesc: 'Klik butang untuk mencari artikel Wikipedia di sekitar lokasi Anda (radius 3km)',
                guideRoute: 'Laluan:',
                guideRouteDesc: 'Lihat panduan arah ke lokasi artikel menggunakan Leaflet Routing',
                guideWiktionary: 'Wiktionary:',
                guideWiktionaryDesc: 'Klik perkataan dalam penerangan untuk mencari definisi',
                guideSearchFilter: 'üîç Carian & Penapis',
                guideSearchBox: 'Kotak Carian:',
                guideSearchBoxDesc: 'Cari artikel berdasarkan nama/tajuk',
                guideSorting: 'Penyusunan:',
                guideSortingDesc: 'Susun hasil berdasarkan jarak terdekat atau nama',
                guideSettings: 'üåç Tetapan',
                guideTheme: 'Tema:',
                guideThemeDesc: 'Pilih tema Light, Dark, atau ikuti keutamaan sistem',
                guideLanguage: 'Bahasa:',
                guideLanguageDesc: 'Ubah bahasa untuk memaparkan kandungan dalam bahasa pilihan',
                guideLocationContent: 'üìç Lokasi & Kandungan',
                guideLocationContentDesc: 'Aplikasi memaparkan artikel dari Wikipedia dalam radius 3km dari lokasi Anda. Setiap artikel memaparkan:',
                guideContentImage: 'Imej kulit dari Wikipedia',
                guideContentDescription: 'Penerangan ringkas (perkataan interaktif ke Wiktionary)',
                guideContentDistance: 'Jarak dari lokasi Anda',
                guideContentWikidata: 'ID Wikidata untuk rujukan lanjut',

                // Tambahkan di akhir object translations.ms
                guideDisclaimerTitle: '‚ö†Ô∏è Penafian Penggunaan Lokasi',
                guideDisclaimerHow: 'Bagaimana Wikilokal Menggunakan Lokasi Anda:',
                guideDisclaimerHowDesc: 'Wikilokal hanya menggunakan koordinat lokasi Anda sementara untuk mencari artikel Wikipedia, Wikivoyage, dan Wiktionary yang mempunyai data geografi di sekitar Anda. Data lokasi tidak disimpan dan tidak dikongsi kepada pihak lain.',
                guideDisclaimerWarningTitle: '‚ö†Ô∏è Amaran Penting:',
                guideDisclaimerWarningDesc: 'Berhati-hati ketika mengambil tangkapan skrin. Alamat lengkap Anda mungkin kelihatan dan boleh mendedahkan lokasi semasa Anda.',
                guideDisclaimerUseTitle: 'Gunakan ciri ini hanya apabila:',
                guideDisclaimerUseSafe: 'Anda berada di tempat yang selamat',
                guideDisclaimerUseConducive: 'Keadaan membenarkan untuk berkongsi lokasi',
                guideDisclaimerPrivacyTitle: 'üîí Privasi Anda:',
                guideDisclaimerPrivacyLaw: 'Mematuhi undang-undang dan ketentuan privasi yang berkuat kuasa',
                guideDisclaimerPrivacyTemp: 'Menggunakan data lokasi hanya untuk keperluan pencarian artikel',
                guideDisclaimerPrivacyNoSave: 'Tidak menyimpan sejarah lokasi Anda'
            },
            en: {
                mainTitle: 'Nearest WikiLocal Articles',
                mainSubtitle: 'Explore Wikipedia within 3km radius of your location',
                theme: 'Theme',
                language: 'Language',
                locationTitle: 'Location Status',
                resultsTitle: 'Search Results',
                checkLocation: 'Search Articles',
                coordinates: 'Coordinates',
                road: 'Road',
                postcode: 'Postcode',
                suburb: 'Suburb',
                city: 'City',
                state: 'State',
                country: 'Country',
                wikidata: 'Wikidata',
                wikivoyage: 'Wikivoyage',
                showRoute: 'Show Route',
                openMaps: 'Open in Google Maps',
                distance: 'km away',
                loading: 'Loading articles...',
                noArticles: 'No articles found within 3km radius',
                description: 'Description not available',
                failedLoad: 'Failed to load description',
                permissionGranted: 'granted',
                permissionDenied: 'denied',
                permissionPending: 'pending',
                locationPermission: 'Location permission: ',
                routeTo: 'Route to ',
                gettingLocation: 'Getting your location...',
                failedLocation: 'Failed to get location: ',
                guideBtn: 'What\'s this?',
                guideBtnTitle: 'View guide',
                checkingPermission: 'Checking permission...',
                searchArticles: 'Search Articles',

                // Modal Guide
                guideTitle: 'üìñ User Guide',
                guideMainFeatures: 'üéØ Main Features',
                guideSearchArticle: 'Search Articles:',
                guideSearchDesc: 'Click the button to find Wikipedia articles around your location (3km radius)',
                guideRoute: 'Route:',
                guideRouteDesc: 'See directions to article locations using Leaflet Routing',
                guideWiktionary: 'Wiktionary:',
                guideWiktionaryDesc: 'Click words in the description to search for definitions',
                guideSearchFilter: 'üîç Search & Filtering',
                guideSearchBox: 'Search Box:',
                guideSearchBoxDesc: 'Search articles by name/title',
                guideSorting: 'Sorting:',
                guideSortingDesc: 'Sort results by nearest distance or name',
                guideSettings: 'üåç Settings',
                guideTheme: 'Theme:',
                guideThemeDesc: 'Choose Light, Dark theme, or follow system preference',
                guideLanguage: 'Language:',
                guideLanguageDesc: 'Change language to display content in your chosen language',
                guideLocationContent: 'üìç Location & Content',
                guideLocationContentDesc: 'The app displays Wikipedia articles within 3km radius of your location. Each article shows:',
                guideContentImage: 'Cover image from Wikipedia',
                guideContentDescription: 'Brief description (interactive words link to Wiktionary)',
                guideContentDistance: 'Distance from your location',
                guideContentWikidata: 'Wikidata ID for further reference',

                // Tambahkan di akhir object translations.en
                guideDisclaimerTitle: '‚ö†Ô∏è Location Usage Disclaimer',
                guideDisclaimerHow: 'How Wikilokal Uses Your Location:',
                guideDisclaimerHowDesc: 'Wikilokal only uses your location coordinates temporarily to find Wikipedia, Wikivoyage, and Wiktionary articles with geographic data around you. Location data is not stored and not shared with third parties.',
                guideDisclaimerWarningTitle: '‚ö†Ô∏è Important Warning:',
                guideDisclaimerWarningDesc: 'Be careful when taking screenshots. Your complete address may be visible and could expose your current location.',
                guideDisclaimerUseTitle: 'Use this feature only when:',
                guideDisclaimerUseSafe: 'You are in a safe place',
                guideDisclaimerUseConducive: 'Conditions allow for location sharing',
                guideDisclaimerPrivacyTitle: 'üîí Your Privacy:',
                guideDisclaimerPrivacyLaw: 'Complying with applicable laws and privacy regulations',
                guideDisclaimerPrivacyTemp: 'Using location data only for article search purposes',
                guideDisclaimerPrivacyNoSave: 'Not storing your location history'
            },
            bew: {
                mainTitle: 'Artikel WikiLokal Paling Deket',
                mainSubtitle: 'Jelajahi Wikipedia dalam radius 3km dari lokasi loe',
                theme: 'Tema',
                language: 'Bahasa',
                locationTitle: 'Status Lokasi',
                resultsTitle: 'Hasil Pencarian',
                checkLocation: 'Cari Artikel',
                coordinates: 'Koordinat',
                road: 'Jalan',
                postcode: 'Kode Pos',
                suburb: 'Kelurahan',
                city: 'Kota',
                state: 'Provinsi',
                country: 'Negara',
                wikidata: 'Wikidata',
                wikivoyage: 'Wikivoyage',
                showRoute: 'Tampilin Rute',
                openMaps: 'Buka di Google Maps',
                distance: 'km jauhnya',
                loading: 'Muatin artikel...',
                noArticles: 'Gak ada artikel dalam radius ',
                description: 'Deskripsi gak ada',
                failedLoad: 'Gagal muatin deskripsi',
                permissionGranted: 'diizinkan',
                permissionDenied: 'ditolak',
                permissionPending: 'nunggu',
                locationPermission: 'Izin lokasi: ',
                routeTo: 'Rute ke ',
                gettingLocation: 'Ngambil lokasi loe...',
                failedLocation: 'Gagal ngambil lokasi: ',
                guideBtn: 'Apaan ni?',
                guideBtnTitle: 'Liat panduan',
                checkingPermission: 'Ngecek izin...',
                searchArticles: 'Cari Artikel',

                // Modal Guide
                guideTitle: 'üìñ Panduan Pemakaian',
                guideMainFeatures: 'üéØ Fitur Utama',
                guideSearchArticle: 'Cari Artikel:',
                guideSearchDesc: 'Klik tombol buat nemuin artikel Wikipedia di sekit lokasi loe (radius 3km)',
                guideRoute: 'Rute:',
                guideRouteDesc: 'Liat petunjuk arah ke lokasi artikel pake Leaflet Routing',
                guideWiktionary: 'Wiktionary:',
                guideWiktionaryDesc: 'Klik kata dalam deskripsi buat cari definisi',
                guideSearchFilter: 'üîç Pencarian & Penyaringan',
                guideSearchBox: 'Kotak Pencarian:',
                guideSearchBoxDesc: 'Cari artikel berdasarkan nama/judul',
                guideSorting: 'Pengurutan:',
                guideSortingDesc: 'Urutkan hasil berdasarkan jarak deket atau nama',
                guideSettings: 'üåç Pengaturan',
                guideTheme: 'Tema:',
                guideThemeDesc: 'Pilih tema Light, Dark, atau ikutin preferensi sistem',
                guideLanguage: 'Bahasa:',
                guideLanguageDesc: 'Ubah bahasa buat tampilin konten dalam bahasa pilihan',
                guideLocationContent: 'üìç Lokasi & Konten',
                guideLocationContentDesc: 'Aplikasi tampilin artikel dari Wikipedia dalam radius 3km dari lokasi loe. Setiap artikel tampilin:',
                guideContentImage: 'Gambar sampul dari Wikipedia',
                guideContentDescription: 'Deskripsi singkat (kata-kata interaktif ke Wiktionary)',
                guideContentDistance: 'Jarak dari lokasi loe',
                guideContentWikidata: 'ID Wikidata buat referensi lanjutan',

                // Tambahkan di akhir object translations.bew
                guideDisclaimerTitle: '‚ö†Ô∏è Penafian Pemakaian Lokasi',
                guideDisclaimerHow: 'Gimana Wikilokal Pake Lokasi Loe:',
                guideDisclaimerHowDesc: 'Wikilokal cuman pake koordinat lokasi loe sementara buat nemuin artikel Wikipedia, Wikivoyage, sama Wiktionary yang punya data geografis di sekit loe. Data lokasi gak disimpen dan gak dibagi ke pihak laen.',
                guideDisclaimerWarningTitle: '‚ö†Ô∏è Peringatan Penting:',
                guideDisclaimerWarningDesc: 'Ati-ati kalo loe ngambil screenshot. Alamat lengkap loe bisa keliatan dan bisa ngebuka lokasi loe sekarang.',
                guideDisclaimerUseTitle: 'Pake fitur ini cuman kalo:',
                guideDisclaimerUseSafe: 'Loe lagi di tempat yang aman',
                guideDisclaimerUseConducive: 'Kondisinya ngijinin buat bagi lokasi',
                guideDisclaimerPrivacyTitle: 'üîí Privasi Loe:',
                guideDisclaimerPrivacyLaw: 'Nurut sama hukum dan ketentuan privasi yang berlaku',
                guideDisclaimerPrivacyTemp: 'Pake data lokasi cuman buat keperluan nyari artikel',
                guideDisclaimerPrivacyNoSave: 'Gak nyimpen riwayat lokasi loe'
            }
        };

        // Selectors
        const languageSelect = document.getElementById('language-select');
        const checkPermissionBtn = document.getElementById('check-permission');
        const permissionStatus = document.getElementById('permission-status');
        const locationStatus = document.getElementById('location-status');
        const resultsList = document.getElementById('results');
        const themeButtons = document.querySelectorAll('.theme-btn');

        let currentLang = 'id';
        let currentPosition = null;
        let currentTheme = 'light';
        const placeholderImage = 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Placeholder_view_vector.svg/1362px-Placeholder_view_vector.svg.png?20220519031949';

        // Translation function
        function t(key) {
            const translation = translations[currentLang]?.[key] || translations['id'][key];
            if (!translation) {
                console.warn(`Translation missing for key: ${key}`);
                return key;
            }
            return translation;
        }

        // OPTIONAL: Tambahkan loading state yang lebih baik
        function showLoading(message = null) {
            const loadingMsg = message || t('loading');
            resultsList.innerHTML = `
        <li class="loading">
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                <div>${loadingMsg}</div>
            </div>
        </li>
    `;
        }

        function showError(message) {
            resultsList.innerHTML = `
        <li class="error">
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                <div>${message}</div>
            </div>
        </li>
    `;
        }

        // Update all static labels
        function updateLabels() {
            document.getElementById('main-title').textContent = t('mainTitle');
            document.getElementById('main-subtitle').textContent = t('mainSubtitle');
            document.getElementById('label-theme').textContent = t('theme');
            document.getElementById('label-language').textContent = t('language');
            document.getElementById('location-title').textContent = t('locationTitle');
            document.getElementById('results-title').textContent = t('resultsTitle');
            document.getElementById('check-permission').textContent = t('checkLocation');
        }

        // Theme management
        function setTheme(theme) {
            currentTheme = theme;
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            localStorage.setItem('wikilokal-theme', theme);
            updateThemeButtons();
        }

        function updateThemeButtons() {
            themeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-theme') === currentTheme) {
                    btn.classList.add('active');
                }
            });
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('wikilokal-theme') || 'light';
            setTheme(savedTheme);
        }

        themeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                setTheme(btn.getAttribute('data-theme'));
            });
        });

        // Check location permission
        async function checkLocationPermission() {
            if (!navigator.permissions || !navigator.geolocation) {
                permissionStatus.textContent = 'API Izin tidak didukung';
                permissionStatus.className = 'denied';
                return 'denied';
            }
            try {
                const result = await navigator.permissions.query({ name: 'geolocation' });
                updatePermissionStatus(result.state);
                result.onchange = () => {
                    updatePermissionStatus(result.state);
                    if (result.state !== 'granted') {
                        currentPosition = null;
                    }
                };
                return result.state;
            } catch (error) {
                console.error('Error memeriksa izin:', error);
                permissionStatus.textContent = 'Gagal memeriksa izin';
                permissionStatus.className = 'error';
                return 'error';
            }
        }

        function updatePermissionStatus(state) {
            permissionStatus.className = '';
            const stateText = state === 'granted' ? t('permissionGranted') :
                state === 'denied' ? t('permissionDenied') : t('permissionPending');
            permissionStatus.textContent = `${t('locationPermission')}${stateText}`;
            permissionStatus.classList.add(state === 'granted' ? 'permitted' : state === 'denied' ? 'denied' : 'pending');
        }

        // Get location details from coordinates
        async function getLocationDetails(lat, lon) {
            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
                const nominatimResponse = await fetch(nominatimUrl, {
                    headers: { 'User-Agent': 'WikiLokal/1.0', 'Accept-Language': currentLang }
                });
                const data = await nominatimResponse.json();
                if (!data.address) {
                    return [{ name: 'Lokasi tidak diketahui', wikidataId: null }];
                }

                const { road, postcode, city, state, country, suburb } = data.address;
                const locationParts = [
                    { name: road || '', type: 'road' },
                    { name: postcode || '', type: 'postcode' },
                    { name: suburb || '', type: 'suburb' },
                    { name: city || '', type: 'city' },
                    { name: state || '', type: 'state' },
                    { name: country || '', type: 'country' }
                ].filter(part => part.name);

                const detailedParts = await Promise.all(locationParts.map(async (part) => {
                    if (!part.name) return { name: part.name, type: part.type, wikidataId: null };
                    if (part.type === 'road' || part.type === 'postcode') {
                        return { name: part.name, type: part.type, wikidataId: null };
                    }
                    try {
                        const wikidataUrl = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(part.name)}&format=json&language=${currentLang}&type=item&origin=*`;
                        const wikidataResponse = await fetch(wikidataUrl);
                        const wikidataData = await wikidataResponse.json();
                        const entity = wikidataData.search[0];
                        return {
                            name: part.name,
                            type: part.type,
                            wikidataId: entity ? entity.id : null
                        };
                    } catch (error) {
                        console.error(`Error mengambil Wikidata untuk ${part.name}:`, error);
                        return { name: part.name, type: part.type, wikidataId: null };
                    }
                }));

                return detailedParts.filter(part => part.name);
            } catch (error) {
                console.error('Error mengambil detail lokasi:', error);
                return [{ name: 'Gagal mengambil detail lokasi', wikidataId: null }];
            }
        }

        // Calculate distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        }

        // Get Wiktionary definition
        async function fetchWiktionaryDefinition(title, lang) {
            try {
                const url = `https://${lang}.wiktionary.org/w/api.php?` +
                    `action=query&titles=${encodeURIComponent(title)}&` +
                    `prop=extracts&exintro&explaintext&exsentences=1&format=json&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                const pages = data.query.pages;
                const page = Object.values(pages)[0];
                return page.extract ? page.extract.trim() : t('description');
            } catch (error) {
                console.error('Error mengambil definisi Wiktionary:', error);
                return t('failedLoad');
            }
        }

        // Extract words dari deskripsi untuk Wiktionary
        function highlightWiktionaryWords(description, lang) {
            if (!description) return '';

            // 1Ô∏è‚É£ Sanitize input ‚Äî remove scripts & HTML tags
            const sanitized = description
                .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '')
                .replace(/<\/?[^>]+(>|$)/g, '');

            // 2Ô∏è‚É£ Escape HTML special characters
            const escapeHtml = (text) =>
                text.replace(/[&<>"']/g, (m) => (
                    { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]
                ));

            // 3Ô∏è‚É£ Split text into tokens (letters, numbers, punctuation, spaces)
            const tokens = sanitized.match(/[\p{L}\p{N}\-']+|[^\p{L}\p{N}\s]+|\s+/gu) || [];

            // 4Ô∏è‚É£ Track already-highlighted words (case-insensitive)
            const seen = new Set();

            // 5Ô∏è‚É£ Process tokens
            const result = tokens.map(token => {
                // check if it's a word
                if (/^[\p{L}\-']+$/u.test(token)) {
                    const lower = token.toLowerCase();

                    // highlight only first occurrence
                    if (!seen.has(lower)) {
                        seen.add(lower);
                        const safeWord = escapeHtml(token);
                        return `<span class="wikt-word" onclick="openWiktionary('${safeWord}', '${lang}')">${safeWord}</span>`;
                    }
                }
                // otherwise or if already seen ‚Äî just escape as normal
                return escapeHtml(token);
            }).join('');

            return result;
        }

        // Open Wiktionary for word
        function openWiktionary(word, lang) {
            const lowerWord = word.toLowerCase();
            window.open(`https://${lang}.wiktionary.org/wiki/${encodeURIComponent(lowerWord)}`, '_blank');
        }

        // Fetch article details from Wikipedia
        async function fetchArticleDetails(title, lang) {
            try {
                const wikiUrl = `https://${lang}.wikipedia.org/w/api.php?` +
                    `action=query&titles=${encodeURIComponent(title)}&` +
                    `prop=extracts|pageimages|pageprops&exintro&explaintext&exsentences=2&` +
                    `pithumbsize=250&format=json&origin=*`;
                const wikiResponse = await fetch(wikiUrl);
                const wikiData = await wikiResponse.json();
                const pages = wikiData.query.pages;
                const page = Object.values(pages)[0];

                const wikidataId = page.pageprops?.wikibase_item || null;

                return {
                    description: page.extract || t('description'),
                    image: page.thumbnail?.source || placeholderImage,
                    wikidataId: wikidataId
                };
            } catch (error) {
                console.error('Error mengambil detail artikel:', error);
                return {
                    description: t('failedLoad'),
                    image: placeholderImage,
                    wikidataId: null
                };
            }
        }

        // Fetch nearby articles (3km radius)
        async function fetchNearbyArticles(lat, lon, lang) {
            try {
                showLoading(t('loading'));
                const radius = 3000;
                const url = `https://${lang}.wikipedia.org/w/api.php?` +
                    `action=query&list=geosearch&gscoord=${lat}|${lon}&` +
                    `gsradius=${radius}&gslimit=100&format=json&origin=*`;

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.query || !data.query.geosearch) {
                    throw new Error('Invalid response from Wikipedia API');
                }

                return data.query.geosearch;
            } catch (error) {
                console.error('Error fetching articles:', error);
                showError(`Gagal memuat artikel: ${error.message}`);
                return [];
            }
        }

        // Display articles in list
        async function displayArticles(articles) {
            resultsList.innerHTML = '';
            if (articles.length === 0) {
                resultsList.innerHTML = `<li>${t('noArticles')}</li>`;
                return;
            }

            // Tampilkan jumlah artikel
            const titleSection = document.getElementById('results-title');
            titleSection.textContent = `${t('resultsTitle')} (${articles.length})`;

            // Simpan artikel original untuk filter
            window.allArticles = articles;
            window.filteredArticles = articles;

            await renderArticles(articles);
        }

        // Render articles ke DOM
        async function renderArticles(articles) {
            resultsList.innerHTML = '';

            for (const article of articles) {
                const details = await fetchArticleDetails(article.title, currentLang);
                const distance = calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    article.lat,
                    article.lon
                );

                const li = document.createElement('li');
                li.className = 'article-card';
                li.dataset.distance = distance;
                li.dataset.name = article.title.toLowerCase();

                const img = document.createElement('img');
                img.src = details.image;
                img.alt = article.title;
                img.onerror = () => img.src = placeholderImage;
                li.appendChild(img);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'article-content';

                const link = document.createElement('a');
                link.href = `https://${currentLang}.wikipedia.org/wiki/${encodeURIComponent(article.title)}`;
                link.textContent = article.title;
                link.target = '_blank';
                contentDiv.appendChild(link);

                const desc = document.createElement('div');
                desc.className = 'description';
                desc.innerHTML = highlightWiktionaryWords(details.description, currentLang);
                contentDiv.appendChild(desc);

                const dist = document.createElement('div');
                dist.className = 'distance';
                dist.textContent = `${distance} ${t('distance')}`;
                contentDiv.appendChild(dist);

                const wd = document.createElement('div');
                wd.className = 'wikidata';
                if (details.wikidataId) {
                    wd.innerHTML = `${t('wikidata')}: <a href="https://www.wikidata.org/wiki/${details.wikidataId}" target="_blank">${details.wikidataId}</a>`;
                } else {
                    wd.textContent = `${t('wikidata')}: T/A`;
                }
                contentDiv.appendChild(wd);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'card-actions';

                const routeBtn = document.createElement('button');
                routeBtn.className = 'route-btn';
                routeBtn.textContent = t('showRoute');
                routeBtn.onclick = () => showRoutePopup(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    article.lat,
                    article.lon,
                    article.title
                );
                actionsDiv.appendChild(routeBtn);

                contentDiv.appendChild(actionsDiv);
                li.appendChild(contentDiv);
                resultsList.appendChild(li);
            }
        }

        // Filter dan sort articles
        function filterAndSortArticles() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const sortBy = document.getElementById('sort-select').value;

            if (!window.allArticles) return;

            // Filter by search term
            let filtered = window.allArticles.filter(article =>
                article.title.toLowerCase().includes(searchTerm)
            );

            // Sort
            if (sortBy === 'distance') {
                // Calculate distances untuk sorting
                filtered.sort((a, b) => {
                    const distA = calculateDistance(
                        currentPosition.coords.latitude,
                        currentPosition.coords.longitude,
                        a.lat,
                        a.lon
                    );
                    const distB = calculateDistance(
                        currentPosition.coords.latitude,
                        currentPosition.coords.longitude,
                        b.lat,
                        b.lon
                    );
                    return parseFloat(distA) - parseFloat(distB);
                });
            } else if (sortBy === 'name') {
                filtered.sort((a, b) => a.title.localeCompare(b.title));
            } else if (sortBy === 'name-desc') {
                filtered.sort((a, b) => b.title.localeCompare(a.title));
            }

            window.filteredArticles = filtered;
            renderArticles(filtered);
        }

        // Show route popup with map
        function showRoutePopup(startLat, startLon, endLat, endLon, title) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            document.body.appendChild(overlay);

            const popup = document.createElement('div');
            popup.className = 'map-popup';

            const popupHeader = document.createElement('div');
            popupHeader.className = 'popup-header';

            const popupTitle = document.createElement('div');
            popupTitle.className = 'popup-title';
            popupTitle.textContent = `${t('routeTo')}${title}`;
            popupHeader.appendChild(popupTitle);

            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.className = 'close-btn';
            closeBtn.onclick = () => {
                document.body.removeChild(popup);
                document.body.removeChild(overlay);
            };
            popupHeader.appendChild(closeBtn);

            popup.appendChild(popupHeader);

            const mapContainer = document.createElement('div');
            mapContainer.className = 'map-container';
            popup.appendChild(mapContainer);

            document.body.appendChild(popup);

            const map = L.map(mapContainer).setView([startLat, startLon], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);

            setTimeout(() => {
                map.invalidateSize();
            }, 100);

            const startMarker = L.marker([startLat, startLon]).addTo(map)
                .bindPopup('Lokasi Anda');
            const endMarker = L.marker([endLat, endLon]).addTo(map)
                .bindPopup(title);

            L.Routing.control({
                waypoints: [
                    L.latLng(startLat, startLon),
                    L.latLng(endLat, endLon)
                ],
                routeWhileDragging: false,
                show: true,
                lineOptions: {
                    styles: [{ color: 'blue', weight: 4 }]
                },
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                fitSelectedRoutes: true,
                showAlternatives: false
            }).addTo(map);
        }

        // Get Wikivoyage sitelink
        async function fetchWikivoyageSitelink(qid, lang) {
            try {
                const url = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${qid}&format=json&props=sitelinks&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                const entity = data.entities[qid];
                const sitelinks = entity?.sitelinks || {};
                const wikivoyageKey = `${lang}wikivoyage`;
                const sitelink = sitelinks[wikivoyageKey]?.title || null;
                return sitelink ? `https://${lang}.wikivoyage.org/wiki/${encodeURIComponent(sitelink)}` : null;
            } catch (error) {
                console.error(`Error fetching Wikivoyage sitelink for ${qid}:`, error);
                return null;
            }
        }

        // Update location display
        async function updateLocationDisplay(lat, lon, locationParts) {
            locationStatus.innerHTML = `<p><a class="coord-link" onclick="window.open('https://www.google.com/maps/@${lat},${lon},15z', '_blank')">${t('coordinates')}: ${lat.toFixed(4)}, ${lon.toFixed(4)}</a></p>`;
            for (const part of locationParts) {
                const div = document.createElement('div');
                div.className = 'location-part';
                const span = document.createElement('span');
                const labels = {
                    'road': t('road'),
                    'postcode': t('postcode'),
                    'suburb': t('suburb'),
                    'city': t('city'),
                    'state': t('state'),
                    'country': t('country')
                };
                span.textContent = `${labels[part.type] || part.type}: ${part.name}`;
                div.appendChild(span);

                if (part.type !== 'road' && part.type !== 'postcode') {
                    const wdBtn = document.createElement('button');
                    wdBtn.textContent = part.wikidataId ? `Wikidata (${part.wikidataId})` : 'Wikidata (T/A)';
                    wdBtn.onclick = () => {
                        if (part.wikidataId) {
                            window.open(`https://www.wikidata.org/wiki/${part.wikidataId}`, '_blank');
                        } else {
                            window.open(`https://www.wikidata.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                        }
                    };
                    div.appendChild(wdBtn);

                    const wvBtn = document.createElement('button');
                    wvBtn.textContent = t('wikivoyage');
                    wvBtn.onclick = async () => {
                        if (part.wikidataId) {
                            const directLink = await fetchWikivoyageSitelink(part.wikidataId, currentLang);
                            if (directLink) {
                                window.open(directLink, '_blank');
                            } else {
                                window.open(`https://${currentLang}.wikivoyage.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                            }
                        } else {
                            window.open(`https://${currentLang}.wikivoyage.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                        }
                    };
                    div.appendChild(wvBtn);
                }

                locationStatus.appendChild(div);
            }
        }

        // Get user location
        async function getLocation() {
            if (!navigator.geolocation) {
                locationStatus.innerHTML = `<p class="error">Geolokasi tidak didukung</p>`;
                return;
            }
            locationStatus.innerHTML = `<p class="loading">${t('gettingLocation')}</p>`;
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        currentPosition = position;
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        updatePermissionStatus('granted');
                        const locationParts = await getLocationDetails(lat, lon);
                        await updateLocationDisplay(lat, lon, locationParts);
                        const articles = await fetchNearbyArticles(lat, lon, currentLang);
                        await displayArticles(articles);
                        resolve();
                    },
                    (error) => {
                        locationStatus.innerHTML = `<p class="error">${t('failedLocation')}${error.message}</p>`;
                        updatePermissionStatus('denied');
                        console.error('Geolocation error:', error);
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Function untuk search/refresh articles
        async function searchArticles() {
            try {
                // Cek apakah geolocation tersedia
                if (!navigator.geolocation) {
                    locationStatus.innerHTML = `<p class="error">Geolokasi tidak didukung di browser ini</p>`;
                    return;
                }

                // Reset current position untuk force refresh
                currentPosition = null;

                // Tampilkan loading state
                permissionStatus.textContent = t('gettingLocation');
                permissionStatus.className = 'pending';
                locationStatus.innerHTML = `<p class="loading">${t('gettingLocation')}</p>`;
                resultsList.innerHTML = `<li class="loading">${t('loading')}</li>`;

                // Get location baru
                await getLocation();

            } catch (error) {
                console.error('Error searching articles:', error);
                locationStatus.innerHTML = `<p class="error">${t('failedLocation')}${error.message}</p>`;
                resultsList.innerHTML = `<li class="error">Gagal memuat artikel: ${error.message}</li>`;
            }
        }

        // ========================================
        // FUNCTION UPDATE LANGUAGE
        // ========================================
        function updateLanguage(lang) {
            const t = translations[lang];

            // Update Header Right
            const guideBtn = document.getElementById('guide-btn');
            const checkBtn = document.getElementById('check-permission');

            if (guideBtn) {
                guideBtn.textContent = `üìñ ${t.guideBtn}`;
                guideBtn.title = t.guideBtnTitle;
            }

            if (checkBtn) {
                checkBtn.textContent = `üîç ${t.searchArticles}`;
            }

            // Update Modal Guide Title
            const guideTitle = document.getElementById('guide-title');
            if (guideTitle) guideTitle.textContent = t.guideTitle;

            // Section 0: Penafian Lokasi
            const disclaimerTitle = document.getElementById('guide-disclaimer-title');
            const disclaimerHowTitle = document.getElementById('guide-disclaimer-how-title');
            const disclaimerHowDesc = document.getElementById('guide-disclaimer-how-desc');
            const disclaimerWarningTitle = document.getElementById('guide-disclaimer-warning-title');
            const disclaimerWarningDesc = document.getElementById('guide-disclaimer-warning-desc');
            const disclaimerUseTitle = document.getElementById('guide-disclaimer-use-strong');
            const disclaimerUseSafe = document.getElementById('guide-disclaimer-use-safe');
            const disclaimerUseConducive = document.getElementById('guide-disclaimer-use-conducive');
            const disclaimerPrivacyTitle = document.getElementById('guide-disclaimer-privacy-title');
            const disclaimerPrivacyLaw = document.getElementById('guide-disclaimer-privacy-law');
            const disclaimerPrivacyTemp = document.getElementById('guide-disclaimer-privacy-temp');
            const disclaimerPrivacyNoSave = document.getElementById('guide-disclaimer-privacy-no-save');

            if (disclaimerTitle) disclaimerTitle.textContent = t.guideDisclaimerTitle;
            if (disclaimerHowTitle) disclaimerHowTitle.textContent = t.guideDisclaimerHow;
            if (disclaimerHowDesc) disclaimerHowDesc.innerHTML = t.guideDisclaimerHowDesc;
            if (disclaimerWarningTitle) disclaimerWarningTitle.innerHTML = t.guideDisclaimerWarningTitle;
            if (disclaimerWarningDesc) disclaimerWarningDesc.textContent = t.guideDisclaimerWarningDesc;
            if (disclaimerUseTitle) disclaimerUseTitle.textContent = t.guideDisclaimerUseTitle;
            if (disclaimerUseSafe) disclaimerUseSafe.textContent = t.guideDisclaimerUseSafe;
            if (disclaimerUseConducive) disclaimerUseConducive.textContent = t.guideDisclaimerUseConducive;
            if (disclaimerPrivacyTitle) disclaimerPrivacyTitle.innerHTML = t.guideDisclaimerPrivacyTitle;
            if (disclaimerPrivacyLaw) disclaimerPrivacyLaw.textContent = t.guideDisclaimerPrivacyLaw;
            if (disclaimerPrivacyTemp) disclaimerPrivacyTemp.textContent = t.guideDisclaimerPrivacyTemp;
            if (disclaimerPrivacyNoSave) disclaimerPrivacyNoSave.textContent = t.guideDisclaimerPrivacyNoSave;

            // Section 1: Fitur Utama
            const featuresTitle = document.getElementById('guide-features-title');
            const searchTitle = document.getElementById('guide-search-title');
            const searchDesc = document.getElementById('guide-search-desc');
            const routeTitle = document.getElementById('guide-route-title');
            const routeDesc = document.getElementById('guide-route-desc');
            const wiktTitle = document.getElementById('guide-wikt-title');
            const wiktDesc = document.getElementById('guide-wikt-desc');

            if (featuresTitle) featuresTitle.textContent = t.guideMainFeatures;
            if (searchTitle) searchTitle.textContent = t.guideSearchArticle;
            if (searchDesc) searchDesc.textContent = t.guideSearchDesc;
            if (routeTitle) routeTitle.textContent = t.guideRoute;
            if (routeDesc) routeDesc.textContent = t.guideRouteDesc;
            if (wiktTitle) wiktTitle.textContent = t.guideWiktionary;
            if (wiktDesc) wiktDesc.textContent = t.guideWiktionaryDesc;

            // Section 3: Pengaturan
            const settingsTitle = document.getElementById('guide-settings-title');
            const themeTitle = document.getElementById('guide-theme-title');
            const themeDesc = document.getElementById('guide-theme-desc');
            const langTitle = document.getElementById('guide-lang-title');
            const langDesc = document.getElementById('guide-lang-desc');

            if (settingsTitle) settingsTitle.textContent = t.guideSettings;
            if (themeTitle) themeTitle.textContent = t.guideTheme;
            if (themeDesc) themeDesc.textContent = t.guideThemeDesc;
            if (langTitle) langTitle.textContent = t.guideLanguage;
            if (langDesc) langDesc.textContent = t.guideLanguageDesc;

            // Section 4: Lokasi & Konten
            const locationTitle = document.getElementById('guide-location-title');
            const locationDesc = document.getElementById('guide-location-desc');
            const contentImage = document.getElementById('guide-content-image');
            const contentDesc = document.getElementById('guide-content-desc');
            const contentDistance = document.getElementById('guide-content-distance');
            const contentWikidata = document.getElementById('guide-content-wikidata');

            if (locationTitle) locationTitle.textContent = t.guideLocationContent;
            if (locationDesc) locationDesc.textContent = t.guideLocationContentDesc;
            if (contentImage) contentImage.textContent = t.guideContentImage;
            if (contentDesc) contentDesc.textContent = t.guideContentDescription;
            if (contentDistance) contentDistance.textContent = t.guideContentDistance;
            if (contentWikidata) contentWikidata.textContent = t.guideContentWikidata;
        }

        // Ubah event listener language change
        languageSelect.addEventListener('change', async () => {
            currentLang = languageSelect.value;
            localStorage.setItem('wikilokal-language', currentLang);
            updateLanguage(currentLang);
            updateLabels();

            // Reset current position dan articles
            currentPosition = null;
            window.allArticles = null;
            window.filteredArticles = null;

            // Clear location dan results
            locationStatus.innerHTML = '';
            resultsList.innerHTML = '';

            // Update results title tanpa jumlah
            const titleSection = document.getElementById('results-title');
            titleSection.textContent = t('resultsTitle');

            // Cek dan tampilkan status permission saja
            await checkLocationPermission();
        });
        // Modal close handler (jika belum ada)
        const modalCloseBtn = document.querySelector('.modal-close');
        const modal = document.getElementById('guide-modal');

        if (modalCloseBtn && modal) {
            modalCloseBtn.addEventListener('click', () => {
                modal.classList.remove('show');
            });
        }


        // Search button event - reset articles
        checkPermissionBtn.addEventListener('click', async () => {
            await searchArticles();
        });

        // Guide button
        document.getElementById('guide-btn').addEventListener('click', () => {
            document.getElementById('guide-modal').classList.add('show');
        });

        // Close guide modal
        function closeGuideModal() {
            document.getElementById('guide-modal').classList.remove('show');
        }

        // Close modal saat klik overlay
        document.getElementById('guide-modal').addEventListener('click', (e) => {
            if (e.target.id === 'guide-modal') {
                closeGuideModal();
            }
        });

        // Search input filter
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                filterAndSortArticles();
            });
        }

        // Make functions available globally
        window.closeGuideModal = closeGuideModal;

        // Initialize on page load
        window.onload = async () => {
            // Load saved language
            const savedLang = localStorage.getItem('wikilokal-language') || 'id';
            currentLang = savedLang;
            updateLanguage(currentLang);
            languageSelect.value = savedLang;

            // Initialize theme
            initTheme();

            // Update labels
            updateLabels();

            // Check initial permission
            const initialPermission = await checkLocationPermission();
            if (initialPermission === 'granted') {
                await getLocation();
            }
        };

        // Make openWiktionary available globally
        window.openWiktionary = openWiktionary;
    </script>
</body>

</html>