<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikilokal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #38bdf8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --bg-secondary: #f3f4f6;
            --radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --secondary-color: #2563eb;
            --accent-color: #60a5fa;
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
            --text-color: #f9fafb;
            --text-light: #d1d5db;
            --bg-color: #1f2937;
            --card-bg: #374151;
            --border-color: #4b5563;
            --bg-secondary: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 1.8rem;
            text-align: center;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }


        #controls {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: grid;
            grid-template-columns: repeat(2, auto) 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        @media (max-width: 968px) {
            #controls {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            #check-permission {
                grid-column: 1 / -1;
            }

            .permission-badge {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            #controls {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 0.85rem;
            }

            #theme-select,
            #language-select,
            #check-permission,
            .permission-badge {
                width: 100%;
                grid-column: 1;
            }

            #check-permission {
                justify-content: center;
            }

            .permission-badge {
                text-align: center;
            }
        }

        @media (max-width: 968px) {
            #controls {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            #check-permission {
                grid-column: 1 / -1;
            }

            .permission-badge {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            #controls {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 0.85rem;
            }

            #theme-select,
            #language-select,
            #check-permission,
            .permission-badge {
                width: 100%;
                grid-column: 1;
            }

            #check-permission {
                width: 100%;
                justify-content: center;
            }

            .permission-badge {
                width: 100%;
                text-align: center;
            }

            .header-top {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .header-left {
                justify-content: center;
            }

            .header-right {
                flex-direction: column;
                width: 100%;
                max-width: 320px;
                margin: 0 auto;
            }

            .header-right button {
                width: 100%;
                justify-content: center;
                font-size: 1rem;
                padding: 0.85rem 1rem;
            }

            #main-subtitle {
                font-size: 0.95rem;
            }

            #scroll-to-top {
                bottom: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }
        }

        .permission-badge {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .permission-badge.granted {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .permission-badge.denied {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .permission-badge.pending {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        #article-count {
            color: var(--text-light);
            font-size: 1.2rem;
            font-weight: 400;
        }

        .progress-container {
            text-align: center;
            padding: 2rem;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .progress-text {
            color: var(--text-color);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 100px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 100px;
            transition: width 0.3s ease;
        }

        .progress-count {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        #theme-select,
        #language-select {
            padding: 0.65rem 1rem;
            padding-right: 2.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            font-family: inherit;
            font-size: 0.95rem;
            background-color: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* Custom Arrow untuk Light Mode */
        #theme-select {
            min-width: 140px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E");
        }

        #language-select {
            min-width: 210px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E");
        }

        /* Hover State */
        #theme-select:hover,
        #language-select:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        /* Focus State */
        #theme-select:focus,
        #language-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Dark Mode Arrow */
        [data-theme="dark"] #theme-select,
        [data-theme="dark"] #language-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23d1d5db' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E");
        }

        /* Options styling */
        #theme-select option,
        #language-select option {
            padding: 0.5rem;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        button {
            padding: 0.65rem 1.25rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #check-permission::before {
            content: "üìç";
            font-size: 1rem;
        }

        #location-status {
            margin-bottom: 1.5rem;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
        }

        .coordinates-display {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-color);
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .coordinates-display::before {
            content: "üìç";
            font-size: 1.2rem;
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
            user-select: none;
            padding: 0.75rem;
            border-radius: var(--radius);
            transition: background-color 0.2s;
            background-color: var(--bg-secondary);
        }

        .location-header:hover {
            background-color: var(--border-color);
        }

        .location-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .toggle-icon {
            font-size: 1rem;
            transition: transform 0.3s ease;
            color: var(--text-light);
            font-weight: bold;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .location-details {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .location-details.hidden {
            max-height: 0;
            opacity: 0;
        }

        .location-part {
            margin: 0.75rem 0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
        }

        .location-part span {
            font-weight: 500;
            margin-right: auto;
        }

        .location-part button {
            padding: 0.3rem 0.75rem;
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            font-size: 0.85rem;
        }

        [data-theme="dark"] .location-part button {
            background-color: var(--card-bg);
        }

        .location-part button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        #results {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            padding: 0;
            list-style: none;
        }

        .article-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: row;
            border: 1px solid var(--border-color);
            max-width: 100%;
            margin: 0;
        }

        .article-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            border-color: var(--primary-color);
        }

        .article-card img {
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-right: 1px solid var(--border-color);
        }

        .article-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .article-card a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            display: block;
            transition: color 0.2s;
        }

        .article-card a:hover {
            color: var(--secondary-color);
        }

        /* Badge bahasa dengan border saja */
        .language-badge {
            background: transparent;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            letter-spacing: 0.8px;
            min-width: 38px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .language-badge:hover {
            background: var(--primary-color);
            color: white;
        }

        .description {
            font-size: 0.9rem;
            color: var(--text-color);
            line-height: 1.5;
            margin-bottom: 0.5rem;
            overflow: visible;
            text-overflow: clip;
        }

        .distance {
            display: inline-flex;
            align-items: center;
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.35rem 0.85rem;
            background-color: var(--bg-secondary);
            border-radius: 100px;
            width: fit-content;
            margin-bottom: 0.25rem;
        }

        .distance::before {
            content: "üìç";
            margin-right: 0.5rem;
        }

        .wikidata {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0;
            flex-wrap: wrap;
            margin-bottom: 0.25rem;
        }

        .wikidata a {
            font-size: 0.85rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .wikidata a:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .wiktionary {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .wiktionary span {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .wiktionary button {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.35rem 0.85rem;
            font-size: 0.85rem;
            border-radius: 100px;
            transition: background-color 0.2s, color 0.2s;
        }

        .wiktionary button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .card-actions {
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .route-btn {
            background-color: var(--accent-color);
            flex: 1;
        }

        .route-btn::before {
            content: "üó∫Ô∏è";
            margin-right: 0.5rem;
        }

        .google-maps-btn {
            background-color: #34c759;
            flex: 1;
        }

        .google-maps-btn::before {
            content: "üåç";
            margin-right: 0.5rem;
        }

        .loading,
        .error {
            text-align: center;
            padding: 2rem;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .loading {
            color: var(--text-light);
            animation: pulse 1.5s infinite;
        }

        .error {
            color: var(--danger-color);
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .map-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--primary-color);
            color: white;
        }

        .popup-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .close-btn {
            background: none;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
            margin: 0;
        }

        .close-btn:hover {
            opacity: 0.8;
        }

        .map-container {
            width: 80vw;
            max-width: 800px;
            height: 60vh;
            max-height: 600px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .article-card {
                flex-direction: column;
            }

            .article-card img {
                width: 100%;
                height: 180px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .article-content {
                padding: 1.5rem;
            }

            .map-container {
                width: 90vw;
                height: 50vh;
            }
        }

        /* === PERBAIKAN WARNA TEKS POPUP PETA DI MODE GELAP === */
        .map-popup .leaflet-popup-content-wrapper,
        .map-popup .leaflet-popup-tip,
        .map-popup .leaflet-routing-container,
        .map-popup .leaflet-control {
            background: var(--card-bg) !important;
            color: var(--text-color) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
        }

        .map-popup .leaflet-popup-content {
            color: var(--text-color) !important;
        }

        .map-popup .leaflet-popup-close-button {
            color: white !important;
            font-weight: bold;
        }

        .map-popup .leaflet-popup-close-button:hover {
            color: #ff5f5f !important;
        }

        /* Routing instructions (instruksi belok kiri/kanan dll) */
        .map-popup .leaflet-routing-container {
            border-color: var(--border-color) !important;
        }

        .map-popup .leaflet-routing-icon {
            filter: invert(1) hue-rotate(180deg);
            /* agar ikon arah tetap terlihat di mode gelap */
        }

        @media (prefers-color-scheme: dark) {
            .map-popup .leaflet-routing-icon {
                filter: invert(0);
            }
        }

        /* Khusus marker popup (Lokasi Anda & nama tempat) */
        .map-popup .leaflet-popup-content-wrapper a,
        .map-popup .leaflet-popup-content a {
            color: var(--primary-color) !important;
        }

        .map-popup .leaflet-popup-content-wrapper a:hover,
        .map-popup .leaflet-popup-content a:hover {
            color: var(--accent-color) !important;
        }

        /* Tombol alternatif rute (jika ada) */
        .map-popup .leaflet-routing-alt {
            background: var(--bg-secondary) !important;
            color: var(--text-color) !important;
        }

        /* Header dengan logo */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 250px;
        }

        .wiki-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            align-items: flex-start;
        }

        .header-title h1 {
            margin: 0;
            border: none;
            padding: 0;
            font-size: 1.4rem;
        }

        .header-right {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
        }

        .header-right button {
            padding: 0.65rem 1rem;
            font-size: 0.9rem;
            white-space: nowrap;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Tombol Panduan */
        #guide-btn {
            background-color: var(--bg-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        #guide-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Tombol Kembali ke Affandy Murad */
        #creator-btn {
            background-color: var(--bg-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        #creator-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Modal untuk Panduan */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            animation: fadeIn 0.3s ease-in;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.25s ease;
            color: var(--text-color);
            padding: 0;
            margin: 0;
            line-height: 1;
        }

        .modal-close:hover {
            opacity: 0.7;
        }

        .guide-section {
            margin-bottom: 1.5rem;
        }

        .guide-section h3 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.1rem;
        }

        .guide-section p {
            margin: 0.5rem 0;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .guide-section ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .guide-section li {
            margin: 0.25rem 0;
            font-size: 0.95rem;
        }

        /* Floating scroll to top button */
        #scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 100;
            padding: 0;
        }

        #scroll-to-top:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        #scroll-to-top.show {
            display: flex;
        }

        /* Wiktionary toggle */
        .wiktionary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
            background-color: var(--bg-secondary);
        }

        .wiktionary-header:hover {
            background-color: var(--border-color);
        }

        .wiktionary-header span {
            font-size: 0.85rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .wiktionary-toggle {
            font-size: 0.8rem;
            color: var(--text-light);
            transition: transform 0.3s ease;
        }

        .wiktionary-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .wiktionary-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: var(--bg-secondary);
            border-radius: 4px;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease, margin 0.3s ease;
            opacity: 1;
        }

        .wiktionary-buttons.hidden {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <!-- Header dengan Logo -->
    <div class="header-top">
        <div class="header-left">
            <div class="wiki-logo">W</div>
            <div class="header-title">
                <h1>Wikilokal</h1>
                <p id="main-subtitle">Jelajahi Proyek Wikimedia (Wikipedia, Wikidata, Wikivoyage, Wiktionary, OSM) dalam
                    radius 3 km dari lokasi Anda</p>
            </div>
        </div>
        <div class="header-right">
            <button id="guide-btn" title="Lihat panduan">üìñ Panduan</button>
            <button id="creator-btn" onclick="window.location.href='../'" title=" Kunjungi Affandy Murad">
                üè† Kembali ke Affandy Murad
            </button>
        </div>
    </div>

    <section id="control-section" aria-label="Pengaturan">
        <h2>Pengaturan</h2>
        <div id="controls">
            <select id="theme-select">
                <option value="light">‚òÄÔ∏è Light</option>
                <option value="dark">üåô Dark</option>
                <option value="system">üñ•Ô∏è System</option>
            </select>
            <select id="language-select">
                <option value="id">Bahasa Indonesia (ID)</option>
                <option value="en">Bahasa Inggris (EN)</option>
                <option value="ms">Bahasa Melayu (MS)</option>
                <option value="fr">Bahasa Prancis (FR)</option>
                <option value="zh">Bahasa Mandarin (ZH)</option>
                <option value="es">Bahasa Spanyol (ES)</option>
                <option value="bew">Bahasa Betawi (BEW)</option>
            </select>
            <button id="check-permission">Periksa Lokasi & Cari</button>
            <span id="permission-status" class="permission-badge">Belum diperiksa</span>
        </div>
    </section>

    <section id="location-section" aria-label="Status Lokasi">
        <h2>Status Lokasi</h2>
        <div id="location-status">
            <div class="coordinates-display"></div>
            <div class="location-header" onclick="toggleLocationDetails()">
                <h3>Detail Lokasi</h3>
                <span class="toggle-icon collapsed">‚ñ∂</span>
            </div>
            <div class="location-details hidden" id="location-details-content"></div>
        </div>
    </section>

    <section id="results-section" aria-label="Hasil Pencarian">
        <h2>Hasil Pencarian <span id="article-count"></span></h2>
        <ul id="results"></ul>
    </section>

    <!-- Modal Panduan -->
    <div id="guide-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="guide-title">üìñ Panduan Penggunaan</h2>
                <button class="modal-close">&times;</button>
            </div>

            <!-- Section 0: Penafian Lokasi -->
            <div class="guide-section" data-section="disclaimer">
                <h3 id="guide-disclaimer-title">‚ö†Ô∏è Penafian Penggunaan Lokasi</h3>
                <p id="guide-disclaimer-how"><strong id="guide-disclaimer-how-title">Bagaimana Wikilokal Menggunakan
                        Lokasi Anda:</strong></p>
                <p id="guide-disclaimer-how-desc">Wikilokal hanya menggunakan koordinat lokasi Anda
                    <strong>sementara</strong> untuk menemukan artikel Wikipedia, Wikivoyage, dan Wiktionary yang
                    memiliki data geografis di sekitar Anda. Data lokasi <strong>tidak disimpan</strong> dan
                    <strong>tidak dibagikan</strong> ke pihak lain.
                </p>

                <br />
                <p id="guide-disclaimer-warning-title"><strong>‚ö†Ô∏è Peringatan Penting:</strong></p>
                <p id="guide-disclaimer-warning-desc">Hati-hati saat mengambil screenshot atau memotret layar. Alamat
                    lengkap Anda mungkin terlihat dan dapat mengungkap lokasi Anda saat ini.</p>

                <p id="guide-disclaimer-use-title"><strong id="guide-disclaimer-use-strong">Gunakan fitur ini hanya
                        saat:</strong></p>
                <ul>
                    <li id="guide-disclaimer-use-safe">Anda berada di tempat yang aman</li>
                    <li id="guide-disclaimer-use-conducive">Kondisi memungkinkan untuk berbagi lokasi</li>
                </ul>

                <br />
                <p id="guide-disclaimer-privacy-title"><strong>üîí Privasi Anda:</strong></p>
                <ul>
                    <li id="guide-disclaimer-privacy-law">Mematuhi hukum dan ketentuan privasi yang berlaku</li>
                    <li id="guide-disclaimer-privacy-temp">Menggunakan data lokasi hanya untuk keperluan pencarian
                        artikel</li>
                    <li id="guide-disclaimer-privacy-no-save">Tidak menyimpan riwayat lokasi Anda</li>
                </ul>
            </div>

            <br />

            <!-- Section 1: Fitur Utama -->
            <div class="guide-section" data-section="features">
                <h3 id="guide-features-title">üéØ Fitur Utama</h3>
                <ul>
                    <li>
                        <strong id="guide-search-title">Cari Artikel:</strong>
                        <span id="guide-search-desc">Klik tombol untuk menemukan artikel Wikipedia di sekitar lokasi
                            Anda (radius 3km)</span>
                    </li>
                    <li>
                        <strong id="guide-route-title">Rute:</strong>
                        <span id="guide-route-desc">Lihat petunjuk arah ke lokasi artikel menggunakan Leaflet
                            Routing</span>
                    </li>
                    <li>
                        <strong id="guide-wikt-title">Wiktionary:</strong>
                        <span id="guide-wikt-desc">Klik kata dalam deskripsi untuk mencari definisi</span>
                    </li>
                </ul>
            </div>

            <!-- Section 3: Pengaturan -->
            <div class="guide-section" data-section="settings">
                <h3 id="guide-settings-title">üåç Pengaturan</h3>
                <ul>
                    <li>
                        <strong id="guide-theme-title">Tema:</strong>
                        <span id="guide-theme-desc">Pilih tema Light, Dark, atau ikuti preferensi sistem</span>
                    </li>
                    <li>
                        <strong id="guide-lang-title">Bahasa:</strong>
                        <span id="guide-lang-desc">Ubah bahasa untuk menampilkan konten dalam bahasa pilihan</span>
                    </li>
                </ul>
            </div>

        </div>
    </div>

    <!-- Floating Scroll to Top Button -->
    <button id="scroll-to-top" title="Kembali ke atas" aria-label="Scroll to top">
        ‚Üë
    </button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        const themeSelect = document.getElementById('theme-select');
        const languageSelect = document.getElementById('language-select');
        const checkPermissionBtn = document.getElementById('check-permission');
        const permissionStatus = document.getElementById('permission-status');
        const articleCount = document.getElementById('article-count');
        const locationStatus = document.getElementById('location-status');
        const resultsList = document.getElementById('results');
        let currentLang = 'id';
        let currentPosition = null;
        const placeholderImage = 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Placeholder_view_vector.svg/1362px-Placeholder_view_vector.svg.png?20220519031949';

        // Theme management
        function setTheme(theme) {
            if (theme === 'system') {
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', systemTheme);
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            localStorage.setItem('theme', theme);
        }

        // Load saved theme or default to light
        const savedTheme = localStorage.getItem('theme') || 'system';
        themeSelect.value = savedTheme;
        setTheme(savedTheme);

        // Listen to system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (themeSelect.value === 'system') {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        themeSelect.addEventListener('change', () => {
            setTheme(themeSelect.value);
        });

        // Update permission status UI ‚Äî versi yang sudah diperbaiki
        function updatePermissionStatus(state) {
            permissionStatus.className = 'permission-badge';

            // PRIORITAS 1: Kalau sudah punya posisi, pasti sudah diizinkan
            if (currentPosition) {
                permissionStatus.textContent = '‚úì Diizinkan';
                permissionStatus.classList.add('granted');
                return;
            }

            // PRIORITAS 2: Kalau belum punya posisi, baru ikuti status permission API
            if (state === 'granted') {
                permissionStatus.textContent = '‚úì Diizinkan';
                permissionStatus.classList.add('granted');
            } else if (state === 'denied') {
                permissionStatus.textContent = '‚úó Ditolak';
                permissionStatus.classList.add('denied');
            } else if (state === 'prompt') {
                permissionStatus.textContent = '? Menunggu';
                permissionStatus.classList.add('pending');
            } else {
                permissionStatus.textContent = 'Belum diperiksa';
                permissionStatus.classList.add('pending');
            }
        }

        // Check permission when needed
        async function checkLocationPermission() {
            if (!navigator.permissions || !navigator.geolocation) {
                updatePermissionStatus('denied');
                return 'denied';
            }
            try {
                const result = await navigator.permissions.query({ name: 'geolocation' });
                updatePermissionStatus(result.state);
                result.onchange = () => {
                    updatePermissionStatus(result.state);
                    if (result.state !== 'granted') {
                        currentPosition = null;
                    }
                };
                return result.state;
            } catch (error) {
                console.error('Error checking permission:', error);
                updatePermissionStatus('denied');
                return 'denied';
            }
        }

        // Toggle location details
        function toggleLocationDetails() {
            const detailsContent = document.getElementById('location-details-content');
            const toggleIcon = document.querySelector('.toggle-icon');

            detailsContent.classList.toggle('hidden');
            toggleIcon.classList.toggle('collapsed');

            // Update arrow text
            if (detailsContent.classList.contains('hidden')) {
                toggleIcon.textContent = '‚ñ∂';
            } else {
                toggleIcon.textContent = '‚ñº';
            }
        }

        async function getLocationDetails(lat, lon) {
            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;

                const nominatimResponse = await fetch(nominatimUrl, {
                    headers: {
                        'User-Agent': 'WikiLokal/1.0',
                        'Accept-Language': currentLang
                    }
                });

                const data = await nominatimResponse.json();
                if (!data.address) {
                    return [{ name: 'Location unknown', wikidataId: null }];
                }

                const { road, postcode, city, state, country, suburb, town, village } = data.address;

                const locationParts = [
                    { name: road, type: 'road' },
                    { name: postcode, type: 'postcode' },
                    { name: suburb, type: 'suburb' },
                    { name: town, type: 'town' },
                    { name: village, type: 'village' },
                    { name: city, type: 'city' },
                    { name: state, type: 'state' },
                    { name: country, type: 'country' }
                ].filter(part => part.name);

                function isGeoDescription(desc) {
                    if (!desc) return false;
                    const d = desc.toLowerCase();
                    return (
                        d.includes("kecamatan") ||
                        d.includes("kelurahan") ||
                        d.includes("district") ||
                        d.includes("administrative") ||
                        d.includes("city") ||
                        d.includes("town") ||
                        d.includes("village") ||
                        d.includes("municipality") ||
                        d.includes("settlement")
                    );
                }

                function matchEntityByType(entity, type) {
                    if (!entity?.description) return false;
                    const desc = entity.description.toLowerCase();

                    const typeKeywords = {
                        suburb: ["kecamatan", "kelurahan", "district", "subdistrict"],
                        town: ["town", "city", "settlement"],
                        village: ["village", "desa", "kelurahan"],
                        city: ["city", "kota", "municipality"],
                        state: ["state", "province", "region"],
                        country: ["country", "nation"]
                    };

                    return typeKeywords[type]?.some(k => desc.includes(k)) || false;
                }

                async function findBestWikidataMatch(name, type) {
                    const url = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(name)}&format=json&language=${currentLang}&type=item&origin=*`;

                    const response = await fetch(url);
                    const data = await response.json();
                    const results = data.search || [];
                    if (!results.length) return null;

                    // 1) Cari yang cocok dengan type
                    const typeMatched = results.find(r => matchEntityByType(r, type));
                    if (typeMatched) return typeMatched;

                    // 2) Cari exact label match + geographic
                    const exactGeo = results.find(r =>
                        r.label?.toLowerCase() === name.toLowerCase() &&
                        isGeoDescription(r.description)
                    );
                    if (exactGeo) return exactGeo;

                    // 3) Cari entitas yang deskripsinya geografis
                    const geoEntity = results.find(r => isGeoDescription(r.description));
                    if (geoEntity) return geoEntity;

                    // 4) fallback: ambil yg label sama tanpa cek deskripsi
                    const exact = results.find(r =>
                        r.label?.toLowerCase() === name.toLowerCase()
                    );
                    if (exact) return exact;

                    // 5) fallback: ambil entity pertama yg bukan non-geo
                    const nonGeoBlacklist = ["month", "family name", "given name"];
                    const safeFirst = results.find(r =>
                        !nonGeoBlacklist.includes((r.description || "").toLowerCase())
                    );
                    if (safeFirst) return safeFirst;

                    // 6) fallback terakhir
                    return results[0];
                }

                const detailedParts = await Promise.all(
                    locationParts.map(async (part) => {
                        if (part.type === 'road' || part.type === 'postcode') {
                            return { ...part, wikidataId: null };
                        }

                        const entity = await findBestWikidataMatch(part.name, part.type);
                        return {
                            ...part,
                            wikidataId: entity?.id ?? null
                        };
                    })
                );

                return detailedParts;

            } catch (error) {
                console.error('Error retrieving location details:', error);
                return [{ name: 'Failed to retrieve location details', wikidataId: null }];
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        }

        async function fetchWiktionaryDefinition(title, lang) {
            try {
                const url = `https://${lang}.wiktionary.org/w/api.php?` +
                    `action=query&titles=${encodeURIComponent(title)}&` +
                    `prop=extracts&exintro&explaintext&exsentences=1&format=json&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                const pages = data.query.pages;
                const page = Object.values(pages)[0];
                return page.extract ? page.extract.trim() : 'Definisi tidak tersedia';
            } catch (error) {
                console.error('Error mengambil definisi Wiktionary:', error);
                return 'Gagal memuat definisi';
            }
        }

        async function fetchArticleDetails(title, lang) {
            try {
                const wikiUrl = `https://${lang}.wikipedia.org/w/api.php?` +
                    `action=query&titles=${encodeURIComponent(title)}&` +
                    `prop=extracts|pageimages|pageprops&exintro&explaintext&exsentences=2&` +
                    `pithumbsize=250&format=json&origin=*`;
                const wikiResponse = await fetch(wikiUrl);
                const wikiData = await wikiResponse.json();
                const pages = wikiData.query.pages;
                const page = Object.values(pages)[0];

                const wiktionaryDef = await fetchWiktionaryDefinition(title, lang);

                const wikidataId = page.pageprops?.wikibase_item || null;

                return {
                    description: page.extract || 'Deskripsi tidak tersedia',
                    image: page.thumbnail?.source || placeholderImage,
                    wikidataId: wikidataId,
                    wiktionaryDef: wiktionaryDef
                };
            } catch (error) {
                console.error('Error mengambil detail artikel:', error);
                return {
                    description: 'Gagal memuat deskripsi',
                    image: placeholderImage,
                    wikidataId: null,
                    wiktionaryDef: 'Gagal memuat definisi'
                };
            }
        }

        async function fetchNearbyArticles(lat, lon, lang) {
            try {
                resultsList.innerHTML = '<li class="loading">Memuat artikel...</li>';
                articleCount.textContent = '';
                const radius = 3000; // Changed to 3km
                const url = `https://${lang}.wikipedia.org/w/api.php?` +
                    `action=query&list=geosearch&gscoord=${lat}|${lon}&` +
                    `gsradius=${radius}&gslimit=100&format=json&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                return data.query.geosearch;
            } catch (error) {
                resultsList.innerHTML = `<li class="error">Gagal memuat artikel: ${error.message}</li>`;
                articleCount.textContent = '';
                return [];
            }
        }

        async function displayArticles(articles) {
            if (articles.length === 0) {
                resultsList.innerHTML = '<li>Tidak ada artikel ditemukan dalam radius 3km</li>';
                articleCount.textContent = '(0)';
                return;
            }

            // Show progress
            resultsList.innerHTML = `
                <li class="progress-container">
                    <div class="progress-text">Memuat detail artikel...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-count" id="progress-count">0 / ${articles.length}</div>
                </li>
            `;

            const progressFill = document.getElementById('progress-fill');
            const progressCount = document.getElementById('progress-count');
            const articleElements = [];

            // Fetch all article details with progress
            for (let i = 0; i < articles.length; i++) {
                const article = articles[i];
                const details = await fetchArticleDetails(article.title, currentLang);
                const distance = calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    article.lat,
                    article.lon
                );

                const li = document.createElement('li');
                li.className = 'article-card';

                const img = document.createElement('img');
                img.src = details.image;
                img.alt = article.title;
                img.onerror = () => img.src = placeholderImage;
                li.appendChild(img);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'article-content';

                // Buat container judul + badge bahasa
                const titleContainer = document.createElement('div');
                titleContainer.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
    gap: 0.5rem;
`;

                // Judul artikel
                const link = document.createElement('a');
                link.href = `https://${currentLang}.wikipedia.org/wiki/${encodeURIComponent(article.title)}`;
                link.textContent = article.title;
                link.target = '_blank';
                link.style.cssText = 'font-size:1.2rem; font-weight:700; color:var(--primary-color); text-decoration:none;';
                link.onmouseover = () => link.style.color = 'var(--secondary-color)';
                link.onmouseout = () => link.style.color = 'var(--primary-color)';
                titleContainer.appendChild(link);

                // Badge bahasa (ID, EN, ZH, dll)
                const langBadge = document.createElement('span');
                langBadge.className = 'language-badge';
                langBadge.textContent = currentLang.toUpperCase();
                titleContainer.appendChild(langBadge);

                // Gantikan link lama dengan container baru
                contentDiv.appendChild(titleContainer);

                const desc = document.createElement('div');
                desc.className = 'description';
                desc.style.display = '-webkit-box';
                desc.style.webkitBoxOrient = 'vertical';
                desc.style.overflow = 'visible'; // Ubah dari hidden
                desc.style.textOverflow = 'clip'; // Ubah dari ellipsis
                // Hapus line-clamp agar semua deskripsi terlihat
                desc.textContent = details.description;
                contentDiv.appendChild(desc);

                const dist = document.createElement('div');
                dist.className = 'distance';
                dist.textContent = `${distance} km jauhnya`;
                contentDiv.appendChild(dist);

                const wd = document.createElement('div');
                wd.className = 'wikidata';
                if (details.wikidataId) {
                    wd.innerHTML = `Wikidata: <a href="https://www.wikidata.org/wiki/${details.wikidataId}" target="_blank">${details.wikidataId}</a>`;
                } else {
                    wd.textContent = 'Wikidata: Tidak tersedia';
                }
                contentDiv.appendChild(wd);

                const wiktDiv = document.createElement('div');
                wiktDiv.className = 'wiktionary';

                // Header dengan toggle
                const wiktHeader = document.createElement('div');
                wiktHeader.className = 'wiktionary-header';

                const wiktTitle = document.createElement('span');
                wiktTitle.textContent = 'Wiktionary';
                wiktHeader.appendChild(wiktTitle);

                const toggleIcon = document.createElement('span');
                toggleIcon.className = 'wiktionary-toggle collapsed';
                toggleIcon.textContent = '‚ñº';
                wiktHeader.appendChild(toggleIcon);

                wiktDiv.appendChild(wiktHeader);

                // Container untuk tombol-tombol
                const wiktButtons = document.createElement('div');
                wiktButtons.className = 'wiktionary-buttons hidden';

                // Gabungkan judul + deskripsi untuk ekstraksi kata
                const textSource = `${article.title} ${details.description}`.toLowerCase();

                // Tokenisasi: pisah berdasarkan spasi dan tanda baca umum, bersihkan
                const words = textSource
                    .replace(/[^\p{L}\p{N}]+/gu, ' ')   // ganti semua tanda baca & simbol dengan spasi
                    .split(/\s+/)
                    .map(w => w.trim())
                    .filter(w => w.length >= 3)         // minimal 3 huruf
                    .map(w => w.replace(/^\d+$/, ''))   // buang kata yang hanya angka
                    .filter(Boolean);

                // Deduplikasi sambil mempertahankan urutan pertama muncul
                const seen = new Set();
                const uniqueWords = [];
                for (const word of words) {
                    if (!seen.has(word)) {
                        seen.add(word);
                        uniqueWords.push(word);
                    }
                }

                // Tampilkan semua unique words sebagai tombol
                uniqueWords.forEach(word => {
                    const wiktBtn = document.createElement('button');
                    wiktBtn.textContent = word;
                    wiktBtn.title = `Cari "${word}" di Wiktionary (${currentLang})`;
                    wiktBtn.onclick = (e) => {
                        e.stopPropagation();
                        window.open(
                            `https://${currentLang}.wiktionary.org/wiki/${encodeURIComponent(word)}`,
                            '_blank'
                        );
                    };
                    wiktButtons.appendChild(wiktBtn);
                });

                // Jika tidak ada kata yang layak, sembunyikan atau beri info
                if (uniqueWords.length === 0) {
                    const noDef = document.createElement('span');
                    noDef.textContent = 'Tidak ada kata untuk Wiktionary';
                    noDef.style.color = 'var(--text-light)';
                    noDef.style.fontSize = '0.8rem';
                    wiktButtons.appendChild(noDef);
                }

                wiktDiv.appendChild(wiktButtons);

                // Toggle functionality
                wiktHeader.onclick = () => {
                    wiktButtons.classList.toggle('hidden');
                    toggleIcon.classList.toggle('collapsed');
                };

                contentDiv.appendChild(wiktDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'card-actions';

                const routeBtn = document.createElement('button');
                routeBtn.className = 'route-btn';
                routeBtn.textContent = 'Tampilkan Rute';
                routeBtn.onclick = () => showRoutePopup(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    article.lat,
                    article.lon,
                    article.title
                );
                actionsDiv.appendChild(routeBtn);

                const googleMapsBtn = document.createElement('button');
                googleMapsBtn.className = 'google-maps-btn';
                googleMapsBtn.textContent = 'Buka di Google Maps';
                googleMapsBtn.onclick = () => window.open(
                    `https://www.google.com/maps?q=${article.lat},${article.lon}`,
                    '_blank'
                );
                actionsDiv.appendChild(googleMapsBtn);

                contentDiv.appendChild(actionsDiv);
                li.appendChild(contentDiv);
                articleElements.push(li);

                // Update progress
                const progress = ((i + 1) / articles.length) * 100;
                progressFill.style.width = `${progress}%`;
                progressCount.textContent = `${i + 1} / ${articles.length}`;
            }

            // Display all articles at once
            resultsList.innerHTML = '';
            articleElements.forEach(el => resultsList.appendChild(el));
            articleCount.textContent = `(${articles.length})`;
        }

        function showRoutePopup(startLat, startLon, endLat, endLon, title) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            document.body.appendChild(overlay);

            const popup = document.createElement('div');
            popup.className = 'map-popup';

            const popupHeader = document.createElement('div');
            popupHeader.className = 'popup-header';

            const popupTitle = document.createElement('div');
            popupTitle.className = 'popup-title';
            popupTitle.textContent = `Rute ke ${title}`;
            popupHeader.appendChild(popupTitle);

            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.className = 'close-btn';
            closeBtn.onclick = () => {
                document.body.removeChild(popup);
                document.body.removeChild(overlay);
            };
            popupHeader.appendChild(closeBtn);

            popup.appendChild(popupHeader);

            const mapContainer = document.createElement('div');
            mapContainer.className = 'map-container';
            popup.appendChild(mapContainer);

            document.body.appendChild(popup);

            const map = L.map(mapContainer).setView([startLat, startLon], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);

            setTimeout(() => {
                map.invalidateSize();
            }, 100);

            const startMarker = L.marker([startLat, startLon]).addTo(map)
                .bindPopup('Lokasi Anda');
            const endMarker = L.marker([endLat, endLon]).addTo(map)
                .bindPopup(title);

            L.Routing.control({
                waypoints: [
                    L.latLng(startLat, startLon),
                    L.latLng(endLat, endLon)
                ],
                routeWhileDragging: false,
                show: true,
                lineOptions: {
                    styles: [{ color: 'blue', weight: 4 }]
                },
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                fitSelectedRoutes: true,
                showAlternatives: false
            }).addTo(map);
        }

        async function fetchWikivoyageSitelink(qid, lang) {
            try {
                const url = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${qid}&format=json&props=sitelinks&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                const entity = data.entities[qid];
                const sitelinks = entity?.sitelinks || {};
                const wikivoyageKey = `${lang}wikivoyage`;
                const sitelink = sitelinks[wikivoyageKey]?.title || null;
                return sitelink ? `https://${lang}.wikivoyage.org/wiki/${encodeURIComponent(sitelink)}` : null;
            } catch (error) {
                console.error(`Error fetching Wikivoyage sitelink for ${qid}:`, error);
                return null;
            }
        }

        async function updateLocationDisplay(lat, lon, locationParts) {
            const coordsDisplay = document.querySelector('.coordinates-display');
            coordsDisplay.textContent = `Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;

            const detailsContent = document.getElementById('location-details-content');
            detailsContent.innerHTML = '';

            for (const part of locationParts) {
                const div = document.createElement('div');
                div.className = 'location-part';
                const span = document.createElement('span');
                const labels = {
                    'road': 'Jalan',
                    'postcode': 'Kode Pos',
                    'suburb': 'Kelurahan',
                    'city': 'Kota',
                    'state': 'Provinsi',
                    'country': 'Negara'
                };
                span.textContent = `${labels[part.type] || part.type}: ${part.name}`;
                div.appendChild(span);

                if (part.type !== 'road' && part.type !== 'postcode') {
                    const wdBtn = document.createElement('button');
                    wdBtn.textContent = part.wikidataId ? `Wikidata (${part.wikidataId})` : 'Wikidata (T/A)';
                    wdBtn.onclick = () => {
                        if (part.wikidataId) {
                            window.open(`https://www.wikidata.org/wiki/${part.wikidataId}`, '_blank');
                        } else {
                            window.open(`https://www.wikidata.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                        }
                    };
                    div.appendChild(wdBtn);

                    const wvBtn = document.createElement('button');
                    wvBtn.textContent = 'Wikivoyage';
                    wvBtn.onclick = async () => {
                        if (part.wikidataId) {
                            const directLink = await fetchWikivoyageSitelink(part.wikidataId, currentLang);
                            if (directLink) {
                                window.open(directLink, '_blank');
                            } else {
                                window.open(`https://${currentLang}.wikivoyage.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                            }
                        } else {
                            window.open(`https://${currentLang}.wikivoyage.org/w/index.php?search=${encodeURIComponent(part.name)}`, '_blank');
                        }
                    };
                    div.appendChild(wvBtn);
                }

                detailsContent.appendChild(div);
            }
        }

        async function getLocation() {
            if (!navigator.geolocation) {
                const coordsDisplay = document.querySelector('.coordinates-display');
                coordsDisplay.textContent = 'Geolokasi tidak didukung';
                coordsDisplay.style.color = 'var(--danger-color)';
                updatePermissionStatus('denied');
                return;
            }
            const coordsDisplay = document.querySelector('.coordinates-display');
            coordsDisplay.textContent = 'Mengambil lokasi Anda...';
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        currentPosition = position;
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        updatePermissionStatus('granted'); // Update status to granted
                        const locationParts = await getLocationDetails(lat, lon);
                        await updateLocationDisplay(lat, lon, locationParts);
                        const articles = await fetchNearbyArticles(lat, lon, currentLang);
                        await displayArticles(articles);
                        resolve();
                    },
                    (error) => {
                        coordsDisplay.textContent = `Gagal mendapatkan lokasi: ${error.message}`;
                        coordsDisplay.style.color = 'var(--danger-color)';
                        updatePermissionStatus('denied'); // Update status to denied
                        console.error('Geolocation error:', error);
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        async function searchArticles() {
            // Check permission first
            const permissionState = await checkLocationPermission();

            if (permissionState === 'denied') {
                alert('Izin lokasi ditolak. Harap izinkan akses lokasi untuk menggunakan fitur ini.');
                return;
            }

            if (currentPosition) {
                const lat = currentPosition.coords.latitude;
                const lon = currentPosition.coords.longitude;
                const locationParts = await getLocationDetails(lat, lon);
                await updateLocationDisplay(lat, lon, locationParts);
                const articles = await fetchNearbyArticles(lat, lon, currentLang);
                await displayArticles(articles);
            } else {
                await getLocation();
            }
        }

        languageSelect.addEventListener('change', () => {
            currentLang = languageSelect.value;

            // Bersihkan hasil lama
            resultsList.innerHTML = '';
            articleCount.textContent = '';

            if (currentPosition) {
                resultsList.innerHTML = `
            <li style="text-align:center; padding:2rem; background:var(--card-bg); border-radius:var(--radius); box-shadow:var(--shadow); color:var(--text-light);">
                <div style="font-size:2rem; margin-bottom:0.5rem;">Language</div>
                <strong>Bahasa diubah menjadi:</strong><br>
                <strong style="color:var(--primary-color); font-size:1.1rem;">
                    ${languageSelect.options[languageSelect.selectedIndex].text}
                </strong><br><br>
                Klik tombol <strong style="color:var(--accent-color);">"Periksa Lokasi & Cari"</strong><br>
                untuk menampilkan artikel dalam bahasa baru
            </li>
        `;

                permissionStatus.textContent = 'Diizinkan ‚Äî Klik untuk cari ulang';
                permissionStatus.className = 'permission-badge granted';
            }
        });

        checkPermissionBtn.addEventListener('click', async () => {
            await searchArticles();
        });

        // Scroll to top functionality
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        const locationSection = document.getElementById('location-section');

        // Show/hide button based on scroll position
        window.addEventListener('scroll', () => {
            if (!locationSection) return;

            const locationSectionTop = locationSection.getBoundingClientRect().top;

            // Show button when location section is above viewport
            if (locationSectionTop < 0) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        });

        // Scroll to top when button is clicked
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Don't auto-load on page load, wait for user action
        window.onload = () => {
            // Just initialize, don't fetch location
            console.log('WikiLokal ready');
        };

        // Guide button
        document.getElementById('guide-btn').addEventListener('click', () => {
            document.getElementById('guide-modal').classList.add('show');
        });

        // Close guide modal
        function closeGuideModal() {
            document.getElementById('guide-modal').classList.remove('show');
        }

        // Close modal saat klik overlay
        document.getElementById('guide-modal').addEventListener('click', (e) => {
            if (e.target.id === 'guide-modal') {
                closeGuideModal();
            }
        });

        // Tambahkan baris ini: Tutup modal saat klik tombol √ó
        document.querySelector('.modal-close').addEventListener('click', closeGuideModal);

        // Make functions available globally
        window.closeGuideModal = closeGuideModal;
    </script>
</body>

</html>